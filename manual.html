<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>The OCamlbuild manual</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article">
<div id="header">
<h1>The OCamlbuild manual</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>OCamlbuild&#8217;s job is to determine the sequence of calls to the compiler&#8201;&#8212;&#8201;with the right set of command-line flags&#8201;&#8212;&#8201;needed to build your OCaml-centric software project.</p>
</div>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_overview">1. Overview</a>
<ul class="sectlevel2">
<li><a href="#_is_ocamlbuild_well_suited_for_your_project">1.1. Is OCamlbuild well-suited for your project?</a></li>
<li><a href="#_examples">1.2. Examples</a></li>
<li><a href="#_pros_cons_and_alternatives">1.3. Pros, cons, and alternatives</a></li>
<li><a href="#_core_concepts">1.4. Core concepts</a></li>
<li><a href="#_working_with_a_simple_program">1.5. Working with a simple program</a></li>
<li><a href="#Sec_Hygiene">1.6. Hygiene</a></li>
<li><a href="#Sec_Findlib">1.7. <a href="http://projects.camlcity.org/projects/findlib.html">Findlib</a>-based packages</a></li>
<li><a href="#_syntax_extensions">1.8. Syntax extensions</a></li>
<li><a href="#Sec_Archives_documentation">1.9. Archives, documentation</a></li>
<li><a href="#Sec_Directories">1.10. Source and build directories, module paths, include paths</a></li>
</ul>
</li>
<li><a href="#Sec_Reference">2. Reference documentation</a>
<ul class="sectlevel2">
<li><a href="#_file_extensions_of_the_ocaml_compiler_and_common_tools">2.1. File extensions of the OCaml compiler and common tools</a></li>
<li><a href="#_targets_and_rules">2.2. Targets and rules</a></li>
<li><a href="#_deprecated_targets">2.3. Deprecated targets</a></li>
<li><a href="#Sec_Tags">2.4. Tags</a></li>
<li><a href="#_advanced_context_tags">2.5. Advanced (context) tags</a></li>
<li><a href="#_the_code_documentation_code_option">2.6. The <code>-documentation</code> option</a></li>
<li><a href="#Sec_Syntax_of_tags_files">2.7. Syntax of <code>_tags</code> files</a></li>
</ul>
</li>
<li><a href="#Sec_Plugins">3. Enriching OCamlbuild through plugins</a>
<ul class="sectlevel2">
<li><a href="#_how_code_myocamlbuild_ml_code_works">3.1. How <code>myocamlbuild.ml</code> works</a></li>
<li><a href="#_stamps">3.2. Stamps</a></li>
<li><a href="#_pattern_variables">3.3. Pattern variables</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>1. Overview</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_is_ocamlbuild_well_suited_for_your_project"><a class="anchor" href="#_is_ocamlbuild_well_suited_for_your_project"></a>1.1. Is OCamlbuild well-suited for your project?</h3>
<div class="paragraph">
<p>OCamlbuild is extremely convenient to use for simple projects.
If you have a small OCaml project (program or library), you could likely directly invoke <code>ocamlbuild</code> to automatically discover various source files and dependencies, and build executables, library archives or documentation with one-line commands.
In simple cases you don&#8217;t need to write a configuration file at all.</p>
</div>
<div class="paragraph">
<p>A few examples of quick <code>ocamlbuild</code> commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-c"># builds a bytecode executable out of foo.ml and its local dependencies</span>
ocamlbuild <span class="tok-s1">&#39;foo.byte&#39;</span>

<span class="tok-c"># builds a native executable</span>
ocamlbuild <span class="tok-s1">&#39;foo.native&#39;</span>

<span class="tok-c"># builds a library archive from the modules listed (capitalized) in lib.mllib</span>
ocamlbuild <span class="tok-s1">&#39;lib.cma&#39;</span>

<span class="tok-c"># builds OCamldoc documentation from the modules listed in lib.odocl</span>
ocamlbuild <span class="tok-s1">&#39;lib.docdir/index.html&#39;</span>

<span class="tok-c"># enable a few ocamlfind packages and compile in debug mode</span>
ocamlbuild -use-ocamlfind -pkgs <span class="tok-s1">&#39;lwt,react,yojson,sedlex.ppx&#39;</span> -tag <span class="tok-s1">&#39;debug&#39;</span> <span class="tok-s1">&#39;foo.native&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If repeating <code>-pkgs 'lwt,react,yojson,sedlex.ppx' -tag 'debug'</code> becomes bothersome, you can create a <code>_tags</code> file in the project directory with the content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>true: package(lwt), package(react), package(sedlex), package(yojson), debug</pre>
</div>
</div>
<div class="paragraph">
<p>, and then just use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="Sh">ocamlbuild -use-ocamlfind <span class="tok-s1">&#39;foo.native&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>OCamlbuild was designed as a generic build system (it is in fact not OCaml-specific), but also to be expressive enough to cover the specifics of the OCaml language that make writing good <code>Makefile</code>s difficult, such as the dreaded <code>units Foo and Bar make inconsistent assumptions about Baz</code> error.</p>
</div>
</div>
<div class="sect2">
<h3 id="_examples"><a class="anchor" href="#_examples"></a>1.2. Examples</h3>
<div class="paragraph">
<p>We maintain a few self-contained examples of projects using various OCamlbuild features under <a href="examples/"><code>examples/</code></a>:</p>
</div>
<table id="Table_Examples" class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Examples</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Directory</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="examples/01-simple">01-simple</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A minimal example with self-contained OCaml code in the project directory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="examples/02-subdirs">02-subdirs</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OCaml code in <code>lib/</code> and <code>src/</code> subdirectories.
 See &lt;&lt;Sec_Directories&gt; for the details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="examples/03-packages">03-packages</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A simple example of use of an Findlib package (<a href="http://mjambon.com/yojson.html"><code>yojson</code></a>) in an OCamlbuild project.
 See <a href="#Sec_Findlib"><a href="http://projects.camlcity.org/projects/findlib.html">Findlib</a>-based packages</a> introduction section for more details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="examples/04-library">04-library</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A simple example of using a <code>.mllib</code> file to easily build library archives (<code>.cma</code> in bytecode, <code>.cmxa</code> with native compilation).
 See <a href="#Sec_Archives_documentation">Archives, documentation</a> for more details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="examples/05-lex-yacc">05-lex-yacc</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A simple program using <code>ocamllex</code> to generate a lexer, and <a href="http://gallium.inria.fr/~fpottier/menhir/">Menhir</a> to generate a parser (ocamlyacc would work as easily, but we recommend using Menhir instead which is just a better parser generator).
 See <a href="#Sec_ocamlyacc_and_Menhir_targets"><code>ocamlyacc</code> and Menhir targets</a> in <a href="#Sec_Reference">Reference documentation</a> for all parser-relevant options.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">🛈</div>
</td>
<td class="content">
There are many ways to integrate OCamlbuild in your project.
The examples provided so far use a <code>Makefile</code> on top of OCamlbuild to provide the familiar <code>make; make install; make clean</code> interface to users, but you are free to do otherwise.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_pros_cons_and_alternatives"><a class="anchor" href="#_pros_cons_and_alternatives"></a>1.3. Pros, cons, and alternatives</h3>
<div class="sect3">
<h4 id="_pros"><a class="anchor" href="#_pros"></a>1.3.1. Pros</h4>
<div class="ulist">
<ul>
<li>
<p>It ‘Just Works’ for most OCaml projects, with <strong>minimal configuration</strong> work on your part.</p>
</li>
<li>
<p>It is designed from the scratch with <strong>dynamic dependencies</strong> in mind.
Dynamic dependencies are the dependencies that are only determined during the build of the target, e.g., the local modules on which a source file depends, and are not explicitly listed in a configuration file.
This avoids, for example, the dance of pre-generating or post-generating <code>.depends</code> files that is occasionally bothersome with <code>Makefile</code> projects, without requiring you to describe all local dependency relations manually either.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_cons"><a class="anchor" href="#_cons"></a>1.3.2. Cons</h4>
<div class="ulist">
<ul>
<li>
<p>Instead of a homegrown soon-to-become-Turing-complete configuration language, OCamlbuild made the choice of using <strong>OCaml as its configuration language</strong>, and many users dislike this choice.
Most features of OCamlbuild can be controlled through the purely declarative <code>_tags</code> file whose structure is explained in detail in this documentation, but for more complex projects you will eventually need to create a <code>myocamlbuild.ml</code> to configure the tool through its OCaml library interface.
We strive for a simple API and we document it, so that should be more pleasant than you expect.</p>
</li>
<li>
<p>OCamlbuild is not the most efficient build system out there, and in particular its support for <strong>build parallelization</strong> is currently disappointing.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
This could be solved with more engineering effort. OCamlbuild is maintained by volunteers, and your contributions are warmly welcome, see <a href="CONTRIBUTING.adoc"><code>CONTRIBUTING.adoc</code></a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For now, OCamlbuild&#8217;s default build rules will not scale to millions-of-lines codebases.
It is however used in countless useful libraries and projects where this has not been a limitation.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_alternatives"><a class="anchor" href="#_alternatives"></a>1.3.3. Alternatives</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/mmottl/ocaml-makefile">OCaml-Makefile</a>, a generic set of Makefile rules for OCaml projects. Valuable if you want to build OCaml projects with <code>make</code>, without rewriting your own boilerplate from scratch.</p>
</li>
<li>
<p><a href="http://omake.metaprl.org/index.html">OMake</a>, a generic build system that has been succesfully used by several relatively large OCaml projects.</p>
</li>
<li>
<p><a href="https://github.com/janestreet/jenga">jenga</a>, a build tool developed internally at Jane Street. The design is interestingly close to OCamlbuild&#8217;s, but with large engineering efforts oriented towards building their huge internal codebase. There is no easy-to-use frontend layer provided to build OCaml projects (and little documentation), it&#8217;s more of a build-your-own-build-system toolkit for now.</p>
</li>
<li>
<p><a href="https://github.com/ocaml-obuild/obuild">obuild</a> wants to be a really-simple build system with a declarative configuration language that has 80% the features, to cover most simple projects.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">🛈</div>
</td>
<td class="content">
The <a href="https://realworldocaml.org/"><em>Real World OCaml</em></a> textbook uses a tool named <code>corebuild</code>.
This is in fact just a simple wrapper on top of <code>ocamlbuild</code> provided by the OCaml library named <code>core</code>, with some common options for <code>core</code> projects baked in.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_core_concepts"><a class="anchor" href="#_core_concepts"></a>1.4. Core concepts</h3>
<div class="sect3">
<h4 id="_rules_and_targets"><a class="anchor" href="#_rules_and_targets"></a>1.4.1. Rules and targets</h4>
<div class="paragraph">
<p>OCamlbuild knows about a set of <em>rules</em> to build programs.
Rules are OCaml code that specifies on a high level how to build certain kinds of files, named <em>targets</em>, from some dependencies (statically known or dynamically discovered).
For example, a built-in "%.ml &#8594; %.cmo" rule describes how to build any <code>.cmo</code> compilation unit file from the <code>.ml</code> of the same name; if you call <code>ocamlbuild foo.cmo</code>, it will either use <code>foo.ml</code> in your source directory or, if it doesn&#8217;t exist, try to build it, for example from <code>foo.mll</code> or <code>foo.mly</code>.</p>
</div>
<div class="paragraph">
<p>OCamlbuild knows various targets to build all sorts of useful things: byte or native programs (<code>.byte</code>, <code>.native</code>), library archives (<code>.cma</code>, <code>.cmxa</code>, <code>.cmxs</code>), documentation (<code>.docdir/index.html</code>, <code>.docdir/man</code>), etc.
We will detail these in the <a href="#Sec_Reference">Reference</a> section.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tags_and_the_code_tags_code_file"><a class="anchor" href="#_tags_and_the_code_tags_code_file"></a>1.4.2. Tags and the <code>_tags</code> file</h4>
<div class="paragraph">
<p><em>Tags</em> are an abstraction layer designed to specify command-line flags in a declarative style.
If you&#8217;re invoking the compiler directly and wish to build a program with debug information enabled, you need to
pass the <code>-g</code> flag to the compilation and linking step of the build process, but not during an initial syntactic preprocessing step (if any), when building <code>.cma</code> library archives, or when calling <code>ocamldoc</code>.
With OCamlbuild, you can simply add the <code>debug</code> tag to your program&#8217;s targets, and it will sort out when to insert the <code>-g</code> flag or not.</p>
</div>
<div class="paragraph">
<p>To attach tags to your OCamlbuild targets, you write them in a <code>_tags</code> file.
Each line is of the form <code>foo: bar</code>, where <code>bar</code> is a list of tags, and <code>foo</code> is a filter that determines which targets <code>bar</code> applies to.</p>
</div>
<div class="paragraph">
<p>For example, the <code>_tags</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>true: package(toto), package(tata)
&lt;foo.*&gt; or &lt;bar.*&gt;: debug
"strange.ml": rectypes</pre>
</div>
</div>
<div class="paragraph">
<p>will make your whole project (<code>true</code> matches anything) depend on the Findlib packages <code>toto</code> and <code>tata</code>, compile modules <code>foo</code> and <code>bar</code> with debug information, and pass <code>-rectypes</code> when compiling <code>strange.ml</code>&#8201;&#8212;&#8201;but not <code>strange.mli</code>.
For more detail, see the <a href="#Sec_Syntax_of_tags_files">syntax of predicates in tags</a>, and the set of <a href="#Sec_Tags">built-in tags</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="__code_myocamlbuild_ml_code"><a class="anchor" href="#__code_myocamlbuild_ml_code"></a>1.4.3. <code>myocamlbuild.ml</code></h4>
<div class="paragraph">
<p>The <code>_tags</code> file provides a convenient but limited interface to tune your project.
For any more general purpose, we chose to use a configuration file directly written in OCaml, instead of reinventing a home-made configuration language&#8201;&#8212;&#8201;or using your shell as Make does.
Code put in the <code>myocamlbuild.ml</code> file at the root of your project will be compiled and executed by <code>ocamlbuild</code> upon invocation.</p>
</div>
<div class="paragraph">
<p>For simple use cases, you should not have to write a <code>myocamlbuild.ml</code> file, except maybe to specify project-wide configuration options&#8201;&#8212;&#8201;similar to command-line options you would pass to OCamlbuild.
But it also allows to define new rules and targets (for example to support a shiny new preprocessing program), to define new tags or refine the meaning of existing tags.
We will cover these use-cases in the more advanced section <a href="#Sec_Plugins">Enriching OCamlbuild through plugins</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_working_with_a_simple_program"><a class="anchor" href="#_working_with_a_simple_program"></a>1.5. Working with a simple program</h3>
<div class="paragraph">
<p>Simple OCaml projects often have a set of <code>.ml</code> and <code>.mli</code> files that provide useful modules depending on each other, and possibly a main file <code>myprog.ml</code> that contains the main program code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mod1.ml
mod1.mli
mod2.ml
myprog.ml</pre>
</div>
</div>
<div class="paragraph">
<p>You can build your program using either the bytecode compiler, with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">ocamlbuild <span class="tok-s1">&#39;myprog.byte&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or the native compiler, with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">ocamlbuild <span class="tok-s1">&#39;myprog.native&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s look at the organization of your source directory after this compilation command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>_build/
mod1.ml
mod1.mli
mod2.ml
myprog.byte -&gt; _build/myprog.byte*
myprog.ml</pre>
</div>
</div>
<div class="paragraph">
<p>OCamlbuild does all its work in a single <code>_build</code> directory, to help keep your source code directory tree clean.
Targets are therefore built inside <code>_build</code>.
It will generally add a symbolic link for the requested target in the user directory, but if a target does not appear after being built, chances are it is in <code>_build</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="Sec_Hygiene"><a class="anchor" href="#Sec_Hygiene"></a>1.6. Hygiene</h3>
<div class="paragraph">
<p>OCamlbuild will proactively complain if some compiled files/build artifacts were left in the source directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span class="tok-c"># In the source directory of the previous example.</span>
ocamlc -c <span class="tok-s1">&#39;mod2.ml&#39;</span>
ocamlbuild <span class="tok-s1">&#39;myprog.byte&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>  SANITIZE: a total of 2 files that should probably not be in your
    source tree has been found. A script shell file
    "_build/sanitize.sh" is being created.  Check this script and
    run it to remove unwanted files or use other options (such as
    defining hygiene exceptions or using the -no-hygiene option).
  IMPORTANT: I cannot work with leftover compiled files.
  ERROR: Leftover OCaml compilation files:
    File mod2.cmo in . has suffix .cmo
    File mod2.cmi in . has suffix .cmi
  Exiting due to hygiene violations.</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">rm mod2.cm*</code></pre>
</div>
</div>
<div class="paragraph">
<p>If this annoys you, it is possible to exclude some files from this hygiene checking by tagging them with the <code>precious</code> or <code>not_hygienic</code> tags, or to disable the check globally using the <code>-no-hygiene</code> command-line option.</p>
</div>
<div class="paragraph">
<p>The reason for this check is that leftover intermediate files can disrupt the way your build system works.
OCamlbuild knows which target you need (library archives or program executables), and tries to build their dependencies, which first builds the dependencies of those dependencies, etc., until it eventually reaches your source files (the <em>inputs</em> of the build process).
Everything present in the source directory is considered to be an input; if you keep old <code>.cmo</code> files in your source repository, OCamlbuild will not try to rebuild them from source files, but take them as references to produce the final targets, which is not what you want if they are stale.</p>
</div>
</div>
<div class="sect2">
<h3 id="Sec_Findlib"><a class="anchor" href="#Sec_Findlib"></a>1.7. <a href="http://projects.camlcity.org/projects/findlib.html">Findlib</a>-based packages</h3>
<div class="paragraph">
<p>Your project will probably depend on external libraries as well.
Let&#8217;s assume they are provided via the Findlib tool <code>ocamlfind</code>. Suppose we depend on packages <code>tata</code> and <code>toto</code>. To tell OCamlbuild about them, use the tags <code>package(tata)</code> and <code>package(toto)</code>.
You also need to tell OCamlbuild to enable support for <code>ocamlfind</code> by passing the <code>-use-ocamlfind</code> command-line option.</p>
</div>
<div class="paragraph">
<p>So you will have the following <code>_tags</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>true: package(tata), package(toto)</pre>
</div>
</div>
<div class="paragraph">
<p>and invoke compilation with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">ocamlbuild -use-ocamlfind <span class="tok-s1">&#39;myprog.byte&#39;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">🛈</div>
</td>
<td class="content">
Because of the popularity of Findlib you can expect to always invoke <code>ocamlbuild</code> with the <code>-use-ocamlfind</code> option.
We will probably enable <code>-use-ocamlfind</code> by default in future versions of OCamlbuild, but in the meantime feel free to define a shell alias for convenience.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you have a <code>myocamlbuild.ml</code> file (see <a href="#Sec_Plugins">Enriching OCamlbuild through plugins</a>) at the root of your OCamlbuild project, you can use it to set this option, instead of using one command line parameter.
Something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">open</span> <span class="tok-nc">Ocamlbuild_plugin</span>
<span class="tok-k">let</span> <span class="tok-bp">()</span> <span class="tok-o">=</span>
  <span class="tok-n">dispatch</span> <span class="tok-o">(</span><span class="tok-k">function</span>
    <span class="tok-o">|</span> <span class="tok-nc">Before_options</span> <span class="tok-o">-&gt;</span>
      <span class="tok-nn">Options</span><span class="tok-p">.</span><span class="tok-n">use_ocamlfind</span> <span class="tok-o">:=</span> <span class="tok-bp">true</span>
    <span class="tok-o">|</span> <span class="tok-o">_</span> <span class="tok-o">-&gt;</span> <span class="tok-bp">()</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_syntax_extensions"><a class="anchor" href="#_syntax_extensions"></a>1.8. Syntax extensions</h3>
<div class="paragraph">
<p>If you use syntax extensions distributed through <code>ocamlfind</code>, you can use them as any Findlib package, but you must also use the <code>syntax(&#8230;&#8203;)</code> tag to indicate which preprocessor you use: <code>camlp4o</code>, <code>camlp4r</code>, <code>camlp5o</code>, etc.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>true: syntax(camlp4o)
true: package(toto), package(blah.syntax)</pre>
</div>
</div>
<div class="paragraph">
<p>In recent versions of OCamlbuild (since OCaml 4.01), you can also specify this using the <code>-syntax</code> command-line option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">ocamlbuild -use-ocamlfind -syntax <span class="tok-s1">&#39;camlp4o&#39;</span> <span class="tok-s1">&#39;myprog.byte&#39;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">🛈</div>
</td>
<td class="content">
Passing the option <code>-tag "syntax(camlp4o)"</code> will also work in older versions.
More generally, <code>-tag foo</code> will apply the tag <code>foo</code> to all targets, it is equivalent to adding <code>true: foo</code> in your tag line.
Also note that the quoting, <code>-tag "syntax(camlp4o)"</code> instead of <code>-tag syntax(camlp4o)</code>, is necessary for your shell to understand tags that have parentheses.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use <code>-ppx</code> preprocessors, you can use the parametrized tag <code>ppx(&#8230;&#8203;)</code> (<code>-tag "ppx(&#8230;&#8203;)"</code>) to specify the preprocessor to use.</p>
</div>
</div>
<div class="sect2">
<h3 id="Sec_Archives_documentation"><a class="anchor" href="#Sec_Archives_documentation"></a>1.9. Archives, documentation</h3>
<div class="paragraph">
<p>Some OCamlbuild features require you to add new kind of files in your source directory.
Suppose you would like to distribute an archive file <code>mylib.cma</code> that would contain the compilation unit for your modules <code>mod1.ml</code> and <code>mod2.ml</code>.
For this, you should create a file <code>mylib.mllib</code> listing the name of desired modules&#8201;&#8212;&#8201;capitalized, as in OCaml source code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Mod1
Mod2</pre>
</div>
</div>
<div class="paragraph">
<p>OCamlbuild knows about a rule <code>"%.mllib &#8594; %.cma"</code>, so you can then use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">ocamlbuild <span class="tok-s1">&#39;mylib.cma&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or, for a native archive</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">ocamlbuild <span class="tok-s1">&#39;mylib.cmxa&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Producing a shared native library <code>.cmxs</code> is also supported by a different form of file with the same syntax, <code>foo.mldylib</code>.</p>
</div>
<div class="paragraph">
<p>Similarly, if you want to invoke <code>ocamldoc</code> to document your program, you should list the modules you want documented in a <code>.odocl</code> file. If you name it <code>mydoc.odocl</code> for example, you can then invoke:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">ocamlbuild <span class="tok-s1">&#39;mydoc.docdir/index.html&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>, which will produce the documentation in the subdirectory <code>mydoc.docdir</code>, thanks to a rule <code>"%.odocl &#8594; %.docdir/index.html"</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="Sec_Directories"><a class="anchor" href="#Sec_Directories"></a>1.10. Source and build directories, module paths, include paths</h3>
<div class="paragraph">
<p>The "source directories" that <code>ocamlbuild</code> will traverse to look for rule dependencies are a subset of the subdirectory tree rooted at the "root directory", the place where you invoke <code>ocamlbuild</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">❗</div>
</td>
<td class="content">
All filesystem paths discussed in this section are <strong>relative to the root directory</strong>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The build directory contains a copy of the source directories hierarchy, with the source file imported and additional targets produced during the previous builds.
It is by convention the subdirectory <code>_build</code> of the root directory, although this can be set with the <code>-build-dir</code> command-line option.
The build directory is not part of the source directories considered by OCamlbuild.</p>
</div>
<div class="paragraph">
<p>A subdirectory of the subdirectory tree is included in the source directories if it has the "traverse" tag set.
That means that if you want to add "foo/bar" (and its files) as part of the source directories and remove "foo/baz", you can use the following in your <code>_tags</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>"foo/bar": traverse
"foo/baz": -traverse</pre>
</div>
</div>
<div class="paragraph">
<p>If the option <code>-r</code> (for <em>recursive</em>) is passed, then all subdirectories (recursively) are considered part of the source directories by default, except the build directory and directories that look like version-control information (<code>.svn</code>, <code>.bzr</code>, <code>.hg</code>, <code>.git</code>, <code>_darcs</code>).</p>
</div>
<div class="paragraph">
<p>This option is enabled by default <em>if</em> the root directory looks like an OCamlbuild project: either a <code>myocamlbuild.ml</code> or a <code>_tags</code> file is present.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">🛈</div>
</td>
<td class="content">
The reason for this heuristic is that calling <code>ocamlbuild</code> from your home directory could take a very long time if it recursively traverses your subdirectories, to check for hygiene for example.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the root directory does not look like an OCamlbuild project, but you still wish to use it as such, you can just add the <code>-r</code> option explicitly.
In the other direction, you can explicitly disable recursive traverse with <code>true: -traverse</code> in your <code>_tags</code> file.</p>
</div>
<div class="sect3">
<h4 id="_module_paths_and_include_directories"><a class="anchor" href="#_module_paths_and_include_directories"></a>1.10.1. Module paths and include directories</h4>
<div class="paragraph">
<p>On many occasions OCamlbuild needs you to indicate <em>compilation units</em> (set of source and object files for a given OCaml module) located somewhere in the source directories.
The syntax to do this is to use an OCaml module name (in particular, capitalized), prefixed by the relative path from the root directory.
For example, <code>bar/baz/Foo</code> will work with the files <code>bar/baz/[fF]oo.{ml[i],cm*}</code>, depending on the compilation phase.</p>
</div>
<div class="paragraph">
<p>For convenience, it is possible to add a source directory to the set of <em>include paths</em>: paths that do not have to be explicitly prefixed to each module path.
If <code>bar/</code> is in the include path, you can refer to <code>bar/baz/Foo</code> as just <code>baz/Foo</code>.
To add <code>bar</code> to the include path, one can pass the <code>-I bar</code> option to ocamlbuild, or tag <code>"bar": include</code> in the <code>_tags</code> file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">🛈</div>
</td>
<td class="content">
Some have come to see the use of the same syntax <code>-I foo</code> in <code>ocamlbuild</code> and in OCaml compilers as a mistake, because the underlying concepts are rather different.
In particular, it is <em>not</em> the case that passing <code>-I foo</code> to <code>ocamlbuild</code> will transfer this command-line option to underlying compiler invocation.
If <code>foo</code> is inside the source directories, this should not be needed, and if it is outside you are encouraged to rely on <code>ocamlfind</code> packages instead of absolute paths.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Sec_Reference"><a class="anchor" href="#Sec_Reference"></a>2. Reference documentation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter, we cover the built-in targets and tags provided by OCamlbuild.
We will omit features that are deprecated, because we found they lead to bad practices or were superseded by better options.
Of course, given that a <code>myocamlbuild.ml</code> can add new rules and tags, this documentation will always be incomplete.</p>
</div>
<div class="sect2">
<h3 id="_file_extensions_of_the_ocaml_compiler_and_common_tools"><a class="anchor" href="#_file_extensions_of_the_ocaml_compiler_and_common_tools"></a>2.1. File extensions of the OCaml compiler and common tools</h3>
<div class="paragraph">
<p>A large part of the file extensions in OCamlbuild rules have not been designed by OCamlbuild itself, but are standard extensions manipulated by the OCaml compiler.
As you may not be familiar with them, we will recapitulate them now.
For most use-cases OCamlbuild will hide most of those subtleties from you, but having this reference is still useful to understand advanced usage scenarios or read build logs.</p>
</div>
<div class="paragraph">
<p>The OCaml compilers also accept native files (name extensions <code>{.o,.obj}</code>, <code>{.a,.lib}</code>) and even source files (<code>.c</code>) as input arguments, which get passed to the C toolchain (compiler or linker) when producing mixed C/OCaml programs or libraries.</p>
</div>
<table id="Table_File_name_extensions" class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. File name extensions</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">File name, with extension</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo.mll</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lexer description, to be processed by a lexer generator to produce a <code>foo.ml</code> file, and possibly <code>foo.mli</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo.ml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grammar description, to be processed by a parser generator to produce a <code>foo.ml</code> file, and possibly <code>foo.mli</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo.cmo</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OCaml bytecode-compiled object file, providing the implementation of the module <code>Foo</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo.cmi</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OCaml bytecode-compiled object file, providing the interface of the module <code>Foo</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>blah.cma</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OCaml bytecode-compiled archive file, containing a collection of <code>.cmo</code> or <code>.cma</code> files, to be used as a library (for either static or dynamic linking).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo.cmx</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OCaml native-compiled object file, providing the implementation of the module <code>Foo</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo.o</code><br>
<em>under Windows:</em> <code>foo.obj</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complementary native object file for the module <code>Foo</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo.cmxa</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OCaml native-compiled archive file, containing a collection of <code>.cmx</code> files, for static linking only.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo.a</code><br>
 <code>foo.lib</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complementary native library files for a native-compiled archive file <code>foo.cmxa</code>, containing a collection of <code>.o</code> or <code>.obj</code> files.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo.cmxs</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OCaml native-compiled archive file (or "plugin") for dynamic linking, containing a collection of <code>.cmx</code>, <code>.cmxa</code>, <code>.o|.obj</code>, <code>.a|.lib</code> files.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In addition, the following extensions are not enforced by the compiler itself, but are commonly used by OCaml tools:</p>
</div>
<table id="Table_File_name_extensions_common" class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. Additional, commonly found file name extensions</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">File name, with extension</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo.mll</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lexer description, to be processed by a lexer generator to produce a <code>foo.ml</code> file, and possibly <code>foo.mli</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo.mly</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grammar description, to be processed by a parser generator to produce a <code>foo.ml</code> file, and possibly <code>foo.mli</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo.mlp</code><br>
 <code>foo.ml4</code><br>
 <code>foo.mlip</code><br>
 <code>foo.mli4</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Common extensions for files to be processed by an external preprocessor (<code>p</code> for "preprocessing" and <code>4</code> for Camlp4, an influential OCaml preprocessor).</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_targets_and_rules"><a class="anchor" href="#_targets_and_rules"></a>2.2. Targets and rules</h3>
<div class="paragraph">
<p>The built-in OCamlbuild targets for OCaml compilation all rely on file extensions to know which rule to use.
Note that this is not imposed by OCamlbuild rule system, which would allow more flexible patterns.
But it is always the filename of the target that determines which rules to apply to build it.</p>
</div>
<div class="paragraph">
<p>In consequence, OCamlbuild adds specific file extensions to the one listed above (or variations of them), that are the user-interface to use its rules providing certain features.
For example, <code>.inferred.mli</code> is not a standard extension in the OCaml compiler, but it is understood by a built-in rule of OCamlbuild to ask for the <code>.mli</code> that the compiler can auto-generate by typing a <code>.ml</code> file without an explicit interface: running <code>ocamlbuild foo.inferred.mli</code> will first build <code>foo.ml</code> (or find it in the source directory), then generate <code>foo.inferred.mli</code> from it. You are expected to then inspect <code>foo.inferred.mli</code>, ideally add documentation, and then move it to <code>foo.mli</code> by themselves.</p>
</div>
<div class="paragraph">
<p>The target extensions understood by OCamlbuild built-in rules are listed in the following subsections.
Again, note that <code>myocamlbuild</code> plugins may add new targets and rules.</p>
</div>
<div class="sect3">
<h4 id="_basic_targets"><a class="anchor" href="#_basic_targets"></a>2.2.1. Basic targets</h4>
<table id="Table_Basic_targets" class="tableblock frame-all grid-all spread">
<caption class="title">Table 4. Basic targets</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">File name extension</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.cmi</code><br>
 <code>.cmo</code><br>
<code>.cmx</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Builds those intermediate files from the corresponding source files (<code>.ml</code>, and the <code>.mli</code> if it exists).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.byte</code><br>
 <code>.native</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Executables generated from a module and its dependencies for bytecode and native compilation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.mllib</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains a list of module paths (<code>Bar</code>, <code>subdir/Baz</code>) that will be compiled and archived together to build a corresponding <code>.cma</code> or <code>.cmxa</code> target.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.cma</code><br>
 <code>.cmxa</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The preferred way to build a library archive is to use a <code>.mllib</code> file listing its content.
 If a <code>foo.mllib</code> is absent, building the target <code>foo.cm{,x}a</code> will create an archive with <code>foo.cm{o,x}</code> and all the local module it depends upon, transitively.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.mldylib</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains a list of module paths (<code>Bar</code>, <code>subdir/Baz</code>) that will be compiled and archived together to build a corresponding <code>.cmxs</code> target (native plugin).
There is no corresponding concept of bytecode plugin archive, as <code>.cma</code> files (built from <code>.mllib</code> files) support for static and dynamic linking.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.cmxs</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The preferred way to build a plugin archive is to list its content in a <code>.mldylib</code> file. In absence of <code>foo.mldylib</code>, building <code>foo.cmxs</code> will either
+
* build <code>foo.cmxa</code> and copy its content into a <code>.cmxs</code> file (in particular this means that a <code>.cmxs</code> can be created from a <code>.mllib</code> file), or
* build <code>foo.cmx</code> and create a plugin archive containing exactly <code>foo.cmx</code>.
 This differs from the rule for <code>.cm{,x}a</code> files (whose archive include the dependencies of the module <code>Foo</code>), in order to avoid dynamically linking the same modules several times.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.itarget</code><br>
 <code>.otarget</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Building <code>foo.itarget</code> requests the build of the targets listed (one per line) in the corresponding <code>foo.itarget</code> file.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="__code_ocamldoc_code_targets"><a class="anchor" href="#__code_ocamldoc_code_targets"></a>2.2.2. <code>ocamldoc</code> targets</h4>
<div class="paragraph">
<p>These targets will call the documentation generator <code>ocamldoc</code>.</p>
</div>
<table id="Table_ocamldoc_targets" class="tableblock frame-all grid-all spread">
<caption class="title">Table 5. <code>ocamldoc</code> targets</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">File name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.odocl</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains a list of module names for which to produce documentation, using one of the targets listed below.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.docdir/index.html</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Building the target <code>foo.docdir/index.thml</code> will create a subdirectory <code>foo.docdir</code> containing the HTML documentation of all modules listed in <code>foo.odocl</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.docdir/man</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">As <code>.docdir/index.html</code> above, but builds the documentation in <code>man</code> format.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.docdir/bar.tex</code> or <code>.docdic/bar.ltx</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Building the target <code>foo.docdir/bar.tex</code> will build the documentation for the modules listed in <code>foo.odocl</code>, as a LaTeX file named <code>foo.docdir/bar.tex</code>.
 The basename <code>bar</code> is not important, but it is the extension <code>.tex</code> or <code>.ltx</code> that indicates to OCamlbuild that ocamldoc should be asked for a LaTeX output.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.docdir/bar.texi</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as above, but generates documentation in TeXinfo format.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.docdir/bar.dot</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as above, but generates a <code>.dot</code> graph of inter-module dependencies.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Sec_ocamlyacc_and_Menhir_targets"><a class="anchor" href="#Sec_ocamlyacc_and_Menhir_targets"></a>2.2.3. <code>ocamlyacc</code> and Menhir targets</h4>
<div class="paragraph">
<p>OCamlbuild will by default use <code>ocamlyacc</code>, a legacy parser generator that is included in the OCaml distribution.
The third-party parser generator <a href="http://gallium.inria.fr/~fpottier/menhir/">Menhir</a> is superior in all aspects, so you are encouraged to use it instead.
To enable the use of Menhir instead of <code>ocamlyacc</code>, you should pass the <code>-use-menhir</code> option, or have <code>true: use_menhir</code> in your <code>_tags</code> file.
OCamlbuild will then activate menhir-specific builtin rule listed below.</p>
</div>
<table id="Table_ocamlyacc_and_Menhir_targets" class="tableblock frame-all grid-all spread">
<caption class="title">Table 6. <code>ocamlyacc</code> and Menhir targets</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">File name extension</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.mly</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grammar description files. They will be passed on to <code>ocamlyacc</code> to produce the corresponding <code>.ml</code> file, or Menhir if it is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.mlypack</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Menhir (not ocamlyacc) supports building a parser by composing several <code>.mly</code> files together, containing different parts of the grammar description.
 Listing module paths in <code>foo.mlypack</code> will produce <code>foo.ml</code> and <code>foo.mli</code> by combining the <code>.mly</code> files corresponding to the listed modules.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.mly.depends</code><br>
<code>.mlypack.depends</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Menhir (but not <code>ocamlyacc</code>) supports calling <code>ocamldep</code> to approximate the dependencies of the OCaml module on which the generated parser will depend.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_advanced_targets"><a class="anchor" href="#_advanced_targets"></a>2.2.4. Advanced targets</h4>
<table id="Table_Advanced_targets" class="tableblock frame-all grid-all spread">
<caption class="title">Table 7. Advanced targets</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">File name extension</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>.ml.depends</code><br>
 <code>.mli.depends</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Call the <code>ocamldep</code> tool to compute a conservative over-approximation of the external dependencies of the corresponding source file.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>.inferred.mli</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Infer a <code>.mli</code> interface from the corresponding <code>.ml</code> file.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>.mlpack</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Contains a list of module paths (<code>Bar</code>, <code>subdir/Baz</code>) that can be packed as submodules of a <code>.cmo</code> or <code>.cmx</code> file: if <code>foo.mlpack</code> exist, asking for the target <code>foo.cmx</code> will build the modules listed in <code>foo.mlpack</code> and pack them together.<br></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">🛈</div>
</td>
<td class="content">
<div class="title">Packed submodules</div>
<div class="paragraph">
<p>The native OCaml compiler requires the submodules that will be packed to be compiled with the <code>-for-pack Foo</code> option (where <code>Foo</code> is the name of the result of packing), and OCamlbuild does not hide this semantics from the user: you can use the built-in parametrized flag <code>for-pack(Foo)</code> for this purpose.
For example, to build <code>foo.cmx</code> containing <code>Bar</code> and <code>subdir/Baz</code> as packed-submodules, you should have the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>foo.mlpack:
  Bar
  subdir/Baz

_tags:
  &lt;{bar,subdir/baz}.cmx: for-pack(Foo)</pre>
</div>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>.byte.o</code><br>
<code>.byte.obj</code> <em>on Windows</em><br>
<br>
 <code>.byte.so</code><br>
 <code>.byte.dll</code> <em>on Windows</em><br>
 <code>.byte.dylib</code> <em>on OSX</em><br>
<br>
 <code>.byte.c</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Produces object files for static or dynamic linking, or a C source file, by passing the <code>-output-obj</code> option to the OCaml bytecode compiler&#8201;&#8212;&#8201;see <code>-output-obj</code> documentation.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>.native.{o,obj}</code><br>
 <code>.native.{so,dll,dylib}</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Produces object files for static or dynamic linking by passing the <code>-output-obj</code> option to the OCaml native compiler&#8201;&#8212;&#8201;see <code>-output-obj</code> documentation.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>.c</code><br>
 <code>.{o,obj}</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>OCamlbuild can build <code>.{o,obj}</code> files from <code>.c</code> files by passing them to the OCaml compiler (which in turns calls the C toolchain).
 The OCaml compiler called is <code>ocamlc</code> or <code>ocamlopt</code>, depending on whether or not the <code>native</code> flag is set on the <code>.c</code> source file.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>.clib</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Contains a list of file paths (e.g., <code>foo.o</code>, not module paths) to be linked together (by using the standard <code>ocamlmklib</code> tool) to produce a <code>.a</code> or <code>.lib</code> archive (for static linking) or a <code>.so</code> or <code>.dll</code> archive (for dynamic linking).
 The .clib name should be prefixed by <code>lib</code>, and the target name will then a <code>lib</code> or <code>dll</code> prefix, following standard conventions: to build a static library from <code>libfoo.clib</code>, you should require the target <code>libfoo.{a,lib}</code>, and to build a dynamic library you should require the target <code>dllfoo.{so,dll}</code>.
 If <code>foo.o</code> is listed and OCamlbuild is run from Windows, <code>foo.obj</code> will be used instead.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>.mltop</code><br>
 <code>.top</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Requesting the build of <code>foo.top</code> will look for a list of module paths in <code>foo.mltop</code>, and build a custom toplevel with all these modules pre-linked using the standard <code>ocamlmktop</code> tool.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_deprecated_targets"><a class="anchor" href="#_deprecated_targets"></a>2.3. Deprecated targets</h3>
<table id="Table_Deprecated_targets" class="tableblock frame-all grid-all spread">
<caption class="title">Table 8. Deprecated targets</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">File name extension</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.p.* </code><br>
 <code>.d.* </code><br></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>OCamlbuild supports requesting <code>foo.p.{cmx,native}</code> and <code>foo.d.{cmo,byte}</code> to build libraries or executables with profiling information (<code>.p</code>) or debug information (<code>.d</code>) incorporated.
 Unfortunately, this runs counter the simple scheme used by the OCaml compiler to find the object files of a compilation unit dependencies: if <code>Foo</code> depends on a module <code>Bar</code>, the compilation of <code>foo.p.cmx</code> will inspect <code>bar.cmx</code> (rather than <code>bar.p.cmx</code>) for cross-module information&#8201;&#8212;&#8201;this is why <code>.d</code> is not supported for native code, as this defeats the purpose of debug builds.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">🛈</div>
</td>
<td class="content">
<code>.p</code> is not supported for bytecode because bytecode profiling works very differently from native profiling.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The more robust solution is to build <code>foo.{cmo,cmx,byte,native}</code> with the <code>profile</code> or <code>debug</code> flag set (e.g., <code>ocamlbuild -tag 'debug' 'foo.native'</code>, or using the <code>_tags</code> file).
If the flag is set for certain files only, only those will have debugging or profiling information enabled. Note that (contrarily to the <code>.d.cmx</code> approach) this means you cannot keep a both a with-debug-info and a without-debug-info compiled object file for the same module at the same time: building <code>foo.byte</code> with <code>true: debug</code>, then without (or conversely) will rebuild all the <code>.cmo</code> files of all of <code>foo</code> dependencies each time.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.pp.ml</code></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>This target produces a pretty-printing (as OCaml source code) of the OCaml AST produced by preprocessing the corresponding <code>.ml</code> file.
This does not work properly when using <code>ocamlfind</code> to activate Camlp4 preprocessors (the now-preferred way to enable syntax extensions), because <code>ocamlfind</code> does not provide a way to obtain the post-processing output, only to preprocess during compilation.
Note that passing the <code>-dsource</code> compilation flag to the OCaml compiler will make it emit the result post-processing during compilation (as OCaml source code; use <code>-dparsetree</code> for a tree view of the AST).</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="Sec_Tags"><a class="anchor" href="#Sec_Tags"></a>2.4. Tags</h3>
<div class="sect3">
<h4 id="_basic_tags"><a class="anchor" href="#_basic_tags"></a>2.4.1. Basic tags</h4>
<div class="paragraph">
<p>For convenience, we try to offer a tag for each setting exported as command-line parameters by the OCaml compilers and tools.
A builtin tag <code>foo_bar</code> corresponding to the option <code>-foo-bar</code> is in general better than trying to pass <code>-cflags -foo-bar</code> to the ocamlbuild compilation command, as it can enable the <code>-foo-bar</code> flag only when it make sense, in a more fine-grained way that "during a compilation command".</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
If you notice that a compiler-provided command-line option is missing its tag counterpart, this is a bug that you should report against OCamlbuild.
Feel free to look at the implementation and <a href="CONTRIBUTING.adoc">send a patch</a> adding this tag, it is really easy.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_compiler_tags"><a class="anchor" href="#_compiler_tags"></a>Compiler tags</h5>
<div class="ulist">
<ul>
<li>
<p><code>absname</code></p>
</li>
<li>
<p><code>annot</code></p>
</li>
<li>
<p><code>asm</code> (for <code>ocamlopt&#8217;s `-S</code>)</p>
</li>
<li>
<p><code>bin_annot</code></p>
</li>
<li>
<p><code>compat_32</code></p>
</li>
<li>
<p><code>custom</code></p>
</li>
<li>
<p><code>debug</code> (for <code>-g</code>)</p>
</li>
<li>
<p><code>dtypes</code></p>
</li>
<li>
<p><code>for-pack(PackModule)</code></p>
</li>
<li>
<p><code>inline(5)</code></p>
</li>
<li>
<p><code>keep_locs</code></p>
</li>
<li>
<p><code>linkall</code></p>
</li>
<li>
<p><code>no_alias_deps</code></p>
</li>
<li>
<p><code>no_float_const_prop</code></p>
</li>
<li>
<p><code>nolabels</code></p>
</li>
<li>
<p><code>nopervasives</code></p>
</li>
<li>
<p><code>opaque</code></p>
</li>
<li>
<p><code>open(MyPervasives)</code></p>
</li>
<li>
<p><code>output_obj</code></p>
</li>
<li>
<p><code>output_shared</code> (for <code>-cclib -shared</code>, automatically set by <code>.{byte,native}.{so,dll,dylib}</code> targets)</p>
</li>
<li>
<p><code>pp(my_pp_preprocessor)</code></p>
</li>
<li>
<p><code>ppx(my_ppx_preprocessor)</code></p>
</li>
<li>
<p><code>principal</code></p>
</li>
<li>
<p><code>profile</code> (for <code>-p</code>)</p>
</li>
<li>
<p><code>rectypes</code></p>
</li>
<li>
<p><code>runtime_variant(_pic)</code></p>
</li>
<li>
<p><code>safe_string</code></p>
</li>
<li>
<p><code>short_paths</code></p>
</li>
<li>
<p><code>strict_formats</code></p>
</li>
<li>
<p><code>strict_sequence</code></p>
</li>
<li>
<p><code>thread</code></p>
</li>
<li>
<p><code>unsafe_string</code></p>
</li>
<li>
<p><code>warn(A@10-28@40-42-45)</code></p>
</li>
<li>
<p><code>warn_error(+10+40)</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="__code_ocamlfind_code_tags"><a class="anchor" href="#__code_ocamlfind_code_tags"></a><code>ocamlfind</code> tags</h5>
<div class="ulist">
<ul>
<li>
<p><code>package(pkgname)</code></p>
</li>
<li>
<p><code>linkpkg</code></p>
</li>
<li>
<p><code>dontlink(pkgname)</code></p>
</li>
<li>
<p><code>predicate(foo)</code></p>
</li>
<li>
<p><code>syntax(bar)</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="__code_ocamllex_code_tags"><a class="anchor" href="#__code_ocamllex_code_tags"></a><code>ocamllex</code> tags</h5>
<div class="ulist">
<ul>
<li>
<p><code>quiet</code> (<code>-q</code>)</p>
</li>
<li>
<p><code>generate_ml</code> (<code>-ml</code>)</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_menhir_tags"><a class="anchor" href="#_menhir_tags"></a>Menhir tags</h5>
<div class="ulist">
<ul>
<li>
<p><code>only_tokens</code></p>
</li>
<li>
<p><code>infer</code></p>
</li>
<li>
<p><code>explain</code></p>
</li>
<li>
<p><code>external_tokens(TokenModule)</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="__code_camlp4_code_tags"><a class="anchor" href="#__code_camlp4_code_tags"></a><code>camlp4</code> tags</h5>
<div class="ulist">
<ul>
<li>
<p><code>use_caml4_{,bin}</code></p>
</li>
<li>
<p><code>camlp4{rrr,orrr,oof,orf,rf,of,r,o}{,.opt}</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_deprecated_tags"><a class="anchor" href="#_deprecated_tags"></a>2.4.2. Deprecated tags</h4>
<div class="paragraph">
<p>The tags <code>use_{ocamlbuild,ocamldoc,toplevel,graphics,dbm,nums,bigarray,str,unix,dynlink}</code> were designed to indicate that the tagged modules depend on the corresponding libraries from the OCaml distributions (<code>use_{ocamlbuild,ocamldoc,toplevel}</code> allows to compile against the tools' libraries to build plugins).
We now recommend to enable those libraries through their corresponding <code>ocamlfind</code> package.</p>
</div>
</div>
<div class="sect3">
<h4 id="__code_ocamlbuild_code_specific_tags"><a class="anchor" href="#__code_ocamlbuild_code_specific_tags"></a>2.4.3. <code>ocamlbuild</code>-specific tags</h4>
<div class="ulist">
<ul>
<li>
<p><code>not_hygienic</code> and <code>precious</code>: explicitly indicate that a file is part of the source directory and should not be warned about by the hygiene-checking tools.
This is useful if for some reason you are given, for example, a <code>.cmi</code> file to use unchanged in your project.</p>
</li>
<li>
<p><code>traverse</code>: explicitly indicate that OCamlbuild should consider this subdirectory as part of the current project; this flag is set for all subdirectories by default (so OCamlbuild will look in subdirectories recursively to find module dependencies) as soon as the current directory "looks like an OCamlbuild project" (there is either a <code>myocamlbuild.ml</code> or <code><em>tags</code> file present).
This tag is usefully used negative, <code>"foo": -traverse</code>, to say that a part of the local directory hierarchy should _not</em> be considered by OCamlbuild.</p>
</li>
<li>
<p><code>include</code>, <code>traverse</code>: see the section above on source directories and include paths.</p>
</li>
<li>
<p>global tags: setting <code>true: use_mehir</code> in the root <code>_tags</code> file is equivalent to passing the <code>-use-menhir</code> command-line parameter.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_advanced_context_tags"><a class="anchor" href="#_advanced_context_tags"></a>2.5. Advanced (context) tags</h3>
<div class="paragraph">
<p>These tags are generally not meant to be used directly in <code>_tags</code> file, but rather to serve as the context part of tag declarations.
For example, the <code>link</code> flag is automatically added thet set of tags of linking-related command, allowing tag declarations to add specific flags during linking phase only&#8201;&#8212;&#8201;but it would make little sense to explicitly add the <code>link</code> tag to a target in your <code>_tags</code> file.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>language context: <code>c</code> or <code>ocaml</code> indicate whether the compiler invocation are working with OCaml files, or C files (to be passed to the underlying C toolchain).
If you wished to use OCamlbuild for a completely different purpose (not necessarily OCaml-related), for example building LaTeX documents, you could use a corresponding <code>latex</code> tag.</p>
</li>
<li>
<p>compilation stage context: <code>pp</code> (syntactic preprocessing), <code>compile</code> (compilation of source files), <code>link</code> (linking of object files), but also <code>pack</code> (when packing compiled object files), <code>library</code> (when creating library archives), <code>infer_interface</code> (producing a <code>.mli</code> from the corresponding <code>.ml</code>) and <code>toplevel</code> (when building custom toplevels).</p>
</li>
<li>
<p>byte or native compilation context: <code>byte</code> (<code>ocamlc</code>) or <code>native</code> (<code>ocamlopt</code>).</p>
</li>
<li>
<p>extension tags: when building the target <code>foo.bar</code>, a tag <code>extension:bar</code> is added to the set of current tags.
This is used by the builtin <code>ocamldoc</code> rules to enable either <code>-latex</code> or <code>-dot</code> depending on the requested target extension.</p>
</li>
<li>
<p>tool-specific tags: <code>menhir</code>, <code>ocamlyacc</code>, <code>ocamllex</code>, <code>doc</code> (for <code>ocamldoc</code>)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_the_code_documentation_code_option"><a class="anchor" href="#_the_code_documentation_code_option"></a>2.6. The <code>-documentation</code> option</h3>
<div class="paragraph">
<p>Invoking <code>ocamlbuild -documentation</code> will give a list of rules and tags known to OCamlbuild in the current project (including those defined in the <code>myocamlbuild</code> plugin).
This is a good way to quickly look for the tag name corresponding to a particular option, and also more accurate than the above reference manual, which does cannot describe plugin-specific features.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">⚠</div>
</td>
<td class="content">
This output is sensitive to the current configuration.
For example, <code>ocamlbuild -use-ocamlfind -documentation</code> and <code>ocamlbuild -no-ocamlfind -documentation</code> produce different outputs, as the latter does not include <code>ocamlfind</code>-specific tags.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is an example of rule documentation included in the <code>ocamlbuild -documentation</code> output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-n">rule</span> <span class="tok-s2">&quot;ocaml: modular menhir (mlypack)&quot;</span>
  <span class="tok-o">~</span><span class="tok-n">deps</span><span class="tok-o">:[</span> <span class="tok-o">%.</span><span class="tok-n">mlypack</span> <span class="tok-o">]</span>
  <span class="tok-o">~</span><span class="tok-n">prods</span><span class="tok-o">:[</span> <span class="tok-o">%.</span><span class="tok-n">mli</span><span class="tok-o">;</span> <span class="tok-o">%.</span><span class="tok-n">ml</span> <span class="tok-o">]</span>
  <span class="tok-o">~</span><span class="tok-n">doc</span><span class="tok-o">:</span><span class="tok-s2">&quot;Menhir supports building a parser by composing several .mly files</span>
<span class="tok-s2">        together, containing different parts of the grammar description. To</span>
<span class="tok-s2">        use that feature with ocamlbuild, you should create a .mlypack file</span>
<span class="tok-s2">        with the same syntax as .mllib or .mlpack files: a</span>
<span class="tok-s2">        whitespace-separated list of the capitalized module names of the .mly</span>
<span class="tok-s2">        files you want to combine together.&quot;</span>
  <span class="tok-n">your_build_function</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">⚠</div>
</td>
<td class="content">
The previous sample resembles OCaml code (see <a href="#Sec_Rules">Rule declarations</a>), but is not valid OCaml code.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that rule declaration only indicate the static dependencies of rules (those that determine whether or not the rule will be tried). This rule is explicit about the fact that invoking Menhir produces both a <code>.ml</code> and <code>.mli</code>.</p>
</div>
<div class="sect3">
<h4 id="_parameterized_tags"><a class="anchor" href="#_parameterized_tags"></a>2.6.1. Parameterized tags</h4>
<div class="paragraph">
<p><em>Parameterized tags</em> are documented since OCaml version 4.03. An example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>parametrized flag {. compile, ocaml, ppx(my_ppx) .} "-ppx my_ppx"

[...]

flag {. compile, no_alias_deps, ocaml .} "-no-alias-deps"</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Sec_Syntax_of_tags_files"><a class="anchor" href="#Sec_Syntax_of_tags_files"></a>2.7. Syntax of <code>_tags</code> files</h3>
<div class="paragraph">
<p>A <code>_tags</code> file associates file name patterns with tags like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># This is a comment
true: bin_annot, debug
&lt;protocol_*&gt; or &lt;main.*&gt;: package(yojson)</pre>
</div>
</div>
<div class="paragraph">
<p>The general syntax is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{pattern}: {comma-separated tag list}</pre>
</div>
</div>
<div class="paragraph">
<p>These items are ended by a newline.
Comments (starting with <code>#</code>) and empty lines are ignored, and an escaped line break is considered as whitespace (so those items can span multiple lines).</p>
</div>
<div class="paragraph">
<p>The <code>{pattern}</code> part is what we call a "glob expression", which is an expression built of basic logic connective on top of "glob patterns".</p>
</div>
<table id="Table_The_syntax_of_glob_expressions" class="tableblock frame-all grid-all spread">
<caption class="title">Table 9. The syntax of glob expressions</caption>
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 28.5714%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Syntax</th>
<th class="tableblock halign-left valign-top">Example</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;p&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;foo.*&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Paths matching the pattern <code>p</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"s"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"foo/bar.ml"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The exact string <code>s</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>e1 or e2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;*.ml&gt; or &lt;foo/bar.ml&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Paths matching at least one of the expression <code>e1</code> or <code>e2</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>e1 and e2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;*.ml&gt; and &lt;foo_*&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Paths matching both expressions <code>e1</code> and <code>e2</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>not e</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>not &lt;*.mli&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Paths not matching the expression <code>e</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All pathnames.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>( e )</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>( &lt;*&gt; and not &lt;*.*&gt; )</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as <code>e</code> (useful for composing larger expressions).</p></td>
</tr>
</tbody>
</table>
<table id="Table_The_syntax_of_glob_patterns" class="tableblock frame-all grid-all spread">
<caption class="title">Table 10. The syntax of glob patterns</caption>
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 28.5715%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Syntax</th>
<th class="tableblock halign-left valign-top">Example</th>
<th class="tableblock halign-left valign-top">Matches</th>
<th class="tableblock halign-left valign-top">Does not match</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>s</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo.ml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo.ml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>bar.ml</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The exact string <code>s</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>*</code><br>
 <em>(wildcard)</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The empty path<br>
 <code>foo</code><br>
 <code>bar</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>foo/bar</code><br>
 <code>/baz</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any string not containing a slash <code>/</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>?</code><br>
 <em>(joker)</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>?</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>a</code><br>
 <code>b</code><br>
 <code>z</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>/</code><br>
 <code>/bar</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any one-letter string, excluding the slash <code>/</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>**/</code><br>
 <em>(prefix inter-directory wildcard)</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>**/foo.ml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo.ml</code><br>
 <code>bar/foo.ml</code><br>
 <code>bar/baz/foo.ml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>bar/foo</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The empty string, or any string ending with a slash <code>/</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>/**</code><br>
 <em>(suffix inter-directory wildcard)</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo/**</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo</code><br>
 <code>foo/bar</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>bar/foo</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The empty string, or any string starting with a slash <code>/</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>/**/</code><br>
 <em>(infix inter-directory wildcard)</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bar/**/foo.ml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bar/foo.ml</code><br>
 <code>bar/baz/foo.ml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>foo.ml</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any string starting and ending iwth a slash <code>/</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>[r1 r2 r3 &#8230;&#8203;]</code>,<br>
 where each <code>r</code> is either:<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>A single character <code>c</code>; or</p>
</li>
<li>
<p>A range <code>c1-c2</code><br>
<em>(positive character class)</em>.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[a-fA-F0-9_.]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3</code><br>
 <code>F</code><br>
 <code>.</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>z</code><br>
 <code>bar</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any one-letter string made up of characters from one of the given ranges.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>[^ r1 r2 r3 &#8230;&#8203;]</code>,<br>
 where each <code>r</code> is either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A single character <code>c</code>; or</p>
</li>
<li>
<p>A range <code>c1-c2</code><br>
<em>(negative character class)</em>.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[a-fA-F0-9_.]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>z</code><br>
 <code>bar</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>3</code><br>
 <code>F</code><br>
 <code>.</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any one-letter string <strong>not</strong> made up of characters from one of the given ranges.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>p1 p2</code><br>
 <em>(concatenation)</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo</code><br>
 <code>foob</code><br>
 <code>foobar</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>fo</code><br>
 <code>bar</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any string with a (possibly empty) prefix matching the pattern <code>p1</code> and the (possibly empty) remainder matching the pattern <code>p2</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><code>{ p1, p2, &#8230;&#8203; }</code><br>
 <em>(union)</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toto.{ml,mli}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toto.ml</code><br>
 <code>toto.mli</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>toto.</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any string matching one of the given patterns.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In addition, rule patterns may include pattern variables. <code>%(foo: p)</code> will match for the pattern <code>p</code> and name the result <code>%(foo)</code>.
For example, <code>%(path: &lt;**/&gt;)foo.ml</code> is useful. <code>%(foo)</code> will match the pattern <code>true</code> and name the result <code>%(foo)</code>, and finally <code>%</code> will match the pattern <code>true</code> and match the result <code>%</code>.
Consider the following examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>%.cmx
%(dir).docdir/%(file)
%(path:&lt;**/&gt;)lib%(libname:&lt;*&gt; and not &lt;*.*&gt;).so</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Sec_Plugins"><a class="anchor" href="#Sec_Plugins"></a>3. Enriching OCamlbuild through plugins</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_how_code_myocamlbuild_ml_code_works"><a class="anchor" href="#_how_code_myocamlbuild_ml_code_works"></a>3.1. How <code>myocamlbuild.ml</code> works</h3>
<div class="paragraph">
<p>If you have a <code>myocamlbuild.ml</code> file at the root of your OCamlbuild project, the building process will run in two steps.</p>
</div>
<div class="sect3">
<h4 id="_first_step"><a class="anchor" href="#_first_step"></a>3.1.1. First step</h4>
<div class="paragraph">
<p>First, OCamlbuild will compile <code>myocamlbuild.ml</code>, linking it with all the modules that are part of the globally installed <code>ocamlbuild</code> executable.
This will produce a program <code>_build/myocamlbuild</code> that behaves exactly like <code>ocamlbuild</code> itself, except that it also runs the code of your <code>myocamlbuild.ml</code> file.
Immediately after, OCamlbuild will stop (before doing any work on the targets you gave it) and start the <code>_build/myocamlbuild</code> program instead, that will handle the rest of the job.
This is quite close to how, for example, XMonad (a window manager whose configuration files are pure Haskell) works.</p>
</div>
<div class="paragraph">
<p>This means that it is technically possible to do anything in <code>myocamlbuild.ml</code> that could be done by adding more code to the upstream OCamlbuild sources.
But in practice, relying on the implementation internals would be fragile with respect to OCamlbuild version changes.</p>
</div>
<div class="paragraph">
<p>We thus isolated a subset of the OCamlbuild API, exposed by the <code>Ocamlbuild_plugin</code> module, that defines a stable interface for plugin developers.
It lets you manipulate command-line options, define new rules and targets, add new tags or refine the meaning of existing flags, etc.
The signature of this module is the <code>PLUGIN</code> module type of the interface-only <code>signatures.mli</code> file of the OCamlbuild distribution.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">🛈</div>
</td>
<td class="content">
You will find the module source code littered with comments explaining the purpose of the exposed values, but this documentation aspect can still be improved.
We warmly welcome patches to improve this aspect of <code>ocamlbuild</code>&#8201;&#8212;&#8201;<a href="CONTRIBUTING.adoc">or any other aspect</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can influence the <code>myocamlbuild.ml</code> compilation-and-launch process in several ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>no-plugin</code> option allows to ignore the <code>myocamlbuild.ml</code> file and just run the stock <code>ocamlbuild</code> executable on your project.
This means that fancy new rules introduced by <code>myocamlbuild.ml</code> will not be available.</p>
</li>
<li>
<p>The <code>-just-plugin</code> option instructs OCamlbuild to stop compilation after having built the plugin.
It also guarantees that OCamlbuild will try to compile the plugin, which it may not always do, for example when you only ask for cleaning or documentation.</p>
</li>
<li>
<p>The <code>-plugin-option FOO</code> option will pass the command-line option <code>FOO</code> to the <code>myocamlbuild</code> invocation&#8201;&#8212;&#8201;and ignore it during plugin compilation.</p>
</li>
<li>
<p>The <code>-plugin-tag</code> and <code>-plugin-tags</code> options allow to pass tags that will be used to compile the plugin.
For example, if someone develops a nice library to help writing OCamlbuild plugins and distribute as 'toto.ocamlbuild' in <code>ocamlfind</code> then <code>-plugin-tag   "package(toto.ocamlbuild)"</code> will let you use it in your <code>myocamlbuild.ml</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">🛈</div>
</td>
<td class="content">
The rationale for <code>-plugin-option</code> and <code>-plugin-tag</code> to apply during different phases of the process is that an option is meaningful at runtime for the plugin, while a plugin tag is meaningful at compile-time.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_dispatch"><a class="anchor" href="#_dispatch"></a>3.1.2. Dispatch</h4>
<div class="paragraph">
<p>Tag and rule declarations, or configuration option manipulation, are side-effects that modify a global OCamlbuild state.
It would be fragile to write your <code>myocamlbuild.ml</code> with such side-effects performed at module initialization time, in the following style:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">open</span> <span class="tok-nc">Ocamlbuild_plugin</span>
<span class="tok-c">(* bad style *)</span>
<span class="tok-k">let</span> <span class="tok-bp">()</span> <span class="tok-o">=</span>
  <span class="tok-nn">Options</span><span class="tok-p">.</span><span class="tok-n">ocamlc</span> <span class="tok-o">:=</span> <span class="tok-s2">&quot;/better/path/to/ocamlc&quot;</span>
<span class="tok-o">;;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The problem is that you have little idea, and absolutely no flexibility, of the time at which those actions will be performed with respect to all the other actions of OCamlbuild.
In this example, command-line argument parsing will happen after this plugin effect, so the changed option would be overridden by command-line options, which may or may not be what a plugin developer expects.</p>
</div>
<div class="paragraph">
<p>To alleviate this side-effect order issue, OCamlbuild lets you register actions at hook points, to be called at a well-defined place during the OCamlbuild process.
If you want your configuration change to happen after options have been processed, you should in fact write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">open</span> <span class="tok-nc">Ocamlbuild_plugin</span>
<span class="tok-k">let</span> <span class="tok-bp">()</span> <span class="tok-o">=</span>
  <span class="tok-n">dispatch</span> <span class="tok-o">(</span><span class="tok-k">function</span>
    <span class="tok-o">|</span> <span class="tok-nc">After_options</span> <span class="tok-o">-&gt;</span>
      <span class="tok-nn">Options</span><span class="tok-p">.</span><span class="tok-n">ocamlc</span> <span class="tok-o">:=</span> <span class="tok-s2">&quot;...&quot;</span>
    <span class="tok-o">|</span> <span class="tok-o">_</span> <span class="tok-o">-&gt;</span> <span class="tok-bp">()</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>dispatch</code> function register a hook-listening function provided by the user.
Its type is <code>(hook &#8594; unit) &#8594; unit</code>.
The hooks are currently defined as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-c">(** Here is the list of hooks that the dispatch function have to handle.</span>
<span class="tok-c">    Generally one responds to one or two hooks (like After_rules) and do</span>
<span class="tok-c">    nothing in the default case. *)</span>
<span class="tok-k">type</span> <span class="tok-n">hook</span> <span class="tok-o">=</span>
  <span class="tok-o">|</span> <span class="tok-nc">Before_hygiene</span>
  <span class="tok-o">|</span> <span class="tok-nc">After_hygiene</span>
  <span class="tok-o">|</span> <span class="tok-nc">Before_options</span>
  <span class="tok-o">|</span> <span class="tok-nc">After_options</span>
  <span class="tok-o">|</span> <span class="tok-nc">Before_rules</span>
  <span class="tok-o">|</span> <span class="tok-nc">After_rules</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">⚠</div>
</td>
<td class="content">
OCamlbuild does not guarantee any order in which it will call various hooks, except of course that <code>Before_foo</code> always happens before <code>After_foo</code>.
In particular, the <code>hygiene</code> hooks may be called before or after other hooks, or not be called at all if OCamlbuild decides not to check <a href="#Sec_Hygiene">Hygiene</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_flag_declarations"><a class="anchor" href="#_flag_declarations"></a>3.1.3. Flag declarations</h4>
<div class="paragraph">
<p>A flag declaration maps a <em>set of tags</em> to a list of command-line arguments/flags/options/parameters.
These arguments will be added to a given compilation command if each of the tags are present on the given target.</p>
</div>
<div class="paragraph">
<p>The following example can be found in <code>ocaml_specific.ml</code>, the file of the OCamlbuild sources that defines most OCaml-specific tags and rules of OCamlbuild:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-n">flag</span> <span class="tok-o">[</span><span class="tok-s2">&quot;ocaml&quot;</span><span class="tok-o">;</span> <span class="tok-s2">&quot;annot&quot;</span><span class="tok-o">;</span> <span class="tok-s2">&quot;compile&quot;</span><span class="tok-o">]</span> <span class="tok-o">(</span><span class="tok-nc">A</span> <span class="tok-s2">&quot;-annot&quot;</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that the <code>-annot</code> command-line option is added to any compilation command for which those three tags are present.
The tags <code>"ocaml"</code> and <code>"compile"</code> are activated by default by OCamlbuild, <code>"ocaml"</code> for any ocaml-related command, and <code>"compile"</code> specifically for compilation steps&#8201;&#8212;&#8201;as opposed to linking, documentation generation, etc.
The <code>"annot"</code> flag is not passed by default, so this tag declaration will only take effects on targets that are explicitly marked <code>annot</code> in the <code>_tags</code> file.</p>
</div>
<div class="paragraph">
<p>This very simple declarative language, mapping sets of tags to command-line options, is the way to give meaning to OCamlbuild tags&#8201;&#8212;&#8201;either add new ones or overload existing ones.
It is very easy, for example, to pass a different command-line argument depending on whether byte or native-compilation is happening.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-n">flag</span> <span class="tok-o">[</span><span class="tok-s2">&quot;ocaml&quot;</span><span class="tok-o">;</span> <span class="tok-s2">&quot;use_camlp4_bin&quot;</span><span class="tok-o">;</span> <span class="tok-s2">&quot;link&quot;</span><span class="tok-o">;</span> <span class="tok-s2">&quot;byte&quot;</span><span class="tok-o">]</span>
  <span class="tok-o">(</span><span class="tok-nc">A</span><span class="tok-s2">&quot;+camlp4/Camlp4Bin.cmo&quot;</span><span class="tok-o">);</span>
<span class="tok-n">flag</span> <span class="tok-o">[</span><span class="tok-s2">&quot;ocaml&quot;</span><span class="tok-o">;</span> <span class="tok-s2">&quot;use_camlp4_bin&quot;</span><span class="tok-o">;</span> <span class="tok-s2">&quot;link&quot;</span><span class="tok-o">;</span> <span class="tok-s2">&quot;native&quot;</span><span class="tok-o">]</span>
  <span class="tok-o">(</span><span class="tok-nc">A</span><span class="tok-s2">&quot;+camlp4/Camlp4Bin.cmx&quot;</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>A</code> constructor stands for ‘atom(ic)’, and is part of a <code>spec</code> datatype, representing specifications of fragments of command.
We will not describe its most advanced constructors&#8201;&#8212;&#8201;it is again exposed and documented in <code>signatures.mli</code>&#8201;&#8212;&#8201;but the most relevant here are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-c">(** The type for command specifications. That is pieces of command. *)</span>
<span class="tok-ow">and</span> <span class="tok-n">spec</span> <span class="tok-o">=</span>
  <span class="tok-o">|</span> <span class="tok-nc">N</span>              <span class="tok-c">(** No operation. *)</span>
  <span class="tok-o">|</span> <span class="tok-nc">S</span> <span class="tok-k">of</span> <span class="tok-n">spec</span> <span class="tok-kt">list</span> <span class="tok-c">(** A sequence.  This gets flattened in the last stages *)</span>
  <span class="tok-o">|</span> <span class="tok-nc">A</span> <span class="tok-k">of</span> <span class="tok-kt">string</span>    <span class="tok-c">(** An atom. *)</span>
  <span class="tok-o">|</span> <span class="tok-nc">P</span> <span class="tok-k">of</span> <span class="tok-n">pathname</span>  <span class="tok-c">(** A pathname. *)</span>
  <span class="tok-o">[...]</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">💡</div>
</td>
<td class="content">
When introducing new flags, it is sometime difficult to guess which combination of tags to use.
A hint to find the right combination is to have a look at OCamlbuild&#8217;s log file that is saved in <code>_build/_log</code> each time <code>ocamlbuild</code> is run.
It contains the targets OCamlbuild tried to produce, with the associated list of tags and the corresponding command lines.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_parametrized_tags"><a class="anchor" href="#_parametrized_tags"></a>Parametrized tags</h5>
<div class="paragraph">
<p>You can also define families of parametrized tags such as <code>package(foo)</code> or <code>inline(30)</code>.
This is done through the <code>pflag</code> function, which takes a list of usual tags, the special parametrized tag, and a function from the tag parameter to the corresponding command specification.
Again from the <code>PLUGIN</code> module type in <code>signatures.mli</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-c">(** Allows to use [flag] with a parametrized tag (as [pdep] for [dep]).</span>

<span class="tok-c">    Example:</span>
<span class="tok-c">       pflag [&quot;ocaml&quot;; &quot;compile&quot;] &quot;inline&quot;</span>
<span class="tok-c">         (fun count -&gt; S [A &quot;-inline&quot;; A count])</span>
<span class="tok-c">    says that command line option &quot;-inline 42&quot; should be added</span>
<span class="tok-c">    when compiling OCaml modules tagged with &quot;inline(42)&quot;. *)</span>
<span class="tok-k">val</span> <span class="tok-n">pflag</span> <span class="tok-o">:</span> <span class="tok-nn">Tags</span><span class="tok-p">.</span><span class="tok-n">elt</span> <span class="tok-kt">list</span> <span class="tok-o">-&gt;</span> <span class="tok-nn">Tags</span><span class="tok-p">.</span><span class="tok-n">elt</span> <span class="tok-o">-&gt;</span> <span class="tok-o">(</span><span class="tok-kt">string</span> <span class="tok-o">-&gt;</span> <span class="tok-nn">Command</span><span class="tok-p">.</span><span class="tok-n">spec</span><span class="tok-o">)</span> <span class="tok-o">-&gt;</span> <span class="tok-kt">unit</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Sec_Rules"><a class="anchor" href="#Sec_Rules"></a>Rule declarations</h5>
<div class="paragraph">
<p>OCamlbuild let you build your own rules, to teach it how to build new kind of targets.
This is done by calling the <code>rule</code> function from a plugin, which is declared and documented in the <code>PLUGIN</code> module in <code>signatures.mli</code>.
We will not write an exhaustive documentation here (for this, have a look at <code>signatures.mli</code>), but rather expose the most common features through representative examples.</p>
</div>
<div class="paragraph">
<p>Our first example is simple, as it is a rule without dynamic dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-n">rule</span> <span class="tok-s2">&quot;ocaml dependencies ml&quot;</span>
  <span class="tok-o">~</span><span class="tok-n">prod</span><span class="tok-o">:</span><span class="tok-s2">&quot;%.ml.depends&quot;</span>
  <span class="tok-o">~</span><span class="tok-n">dep</span><span class="tok-o">:</span><span class="tok-s2">&quot;%.ml&quot;</span>
  <span class="tok-o">~</span><span class="tok-n">doc</span><span class="tok-o">:</span><span class="tok-s2">&quot;call ocamldep to compute a syntactic over-approximation </span><span class="tok-se">\\</span><span class="tok-s2"></span>
<span class="tok-s2">        of the dependencies of the corresponding implementation file&quot;</span>
  <span class="tok-n">ocamldep_ml_command</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first string parameter is the name of the rule.
This rule tells OCamlbuild how to build <code>foo.ml.depends</code> from its <code>foo.ml</code>. The <code>%</code> character here is a pattern variable: if the target name (e.g., <code>foo.ml.depends</code>) matches the pattern of the rule production <code>%.ml.depends</code> then OCamlbuild will try to build the static dependency of the rule.
The static dependency is the evaluation of <code>%.ml</code> in the pattern-matching environment <code>% &#8594; "foo"</code> (that is, <code>foo.ml</code>).
If this static dependency can be built, then the "action" <code>ocamldep_ml_command</code> will be invoked to produce the expected result.</p>
</div>
<div class="paragraph">
<p>The action, of type <code>PLUGIN.action</code>, is a function that takes the current pattern-matching environment (in our example, mapping the pattern variable <code>%</code> to <code>foo</code>), a builder function, and returns a command, the command to execute to produce the final target of this rule.
A plugin developer defining this rule should define the <code>ocamldep_ml_command</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">ocamldep_ml_command</span> <span class="tok-n">env</span> <span class="tok-o">_</span><span class="tok-n">build</span> <span class="tok-o">=</span>
  <span class="tok-k">let</span> <span class="tok-n">arg</span> <span class="tok-o">=</span> <span class="tok-n">env</span> <span class="tok-s2">&quot;%.ml&quot;</span> <span class="tok-ow">and</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">env</span> <span class="tok-s2">&quot;%.ml.depends&quot;</span> <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-n">tags</span> <span class="tok-o">=</span> <span class="tok-n">tags_of_pathname</span> <span class="tok-n">arg</span> <span class="tok-o">++</span> <span class="tok-s2">&quot;ocaml&quot;</span> <span class="tok-o">++</span> <span class="tok-s2">&quot;ocamldep&quot;</span> <span class="tok-k">in</span>
  <span class="tok-nc">Cmd</span><span class="tok-o">(</span><span class="tok-nc">S</span><span class="tok-o">[</span><span class="tok-nc">A</span> <span class="tok-s2">&quot;ocamldep&quot;</span><span class="tok-o">;</span> <span class="tok-nc">T</span> <span class="tok-n">tags</span><span class="tok-o">;</span> <span class="tok-nc">A</span> <span class="tok-s2">&quot;-modules&quot;</span><span class="tok-o">;</span> <span class="tok-nc">P</span> <span class="tok-n">arg</span><span class="tok-o">;</span> <span class="tok-nc">Sh</span> <span class="tok-s2">&quot;&gt;&quot;</span><span class="tok-o">;</span> <span class="tok-nc">Px</span> <span class="tok-n">out</span><span class="tok-o">])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first line in this definition uses the pattern environment to compute the actual name of the input and output files.
These are then passed in as arguments to the <code>ocamldep</code> command and shell redirect, respectively, on the third line.
The environment type <code>PLUGIN.env</code> is just <code>string &#8594; string</code>, it takes a pattern and substitutes its pattern variables to return a closed result.</p>
</div>
<div class="paragraph">
<p>The second line in this definition computes the tags to include in the command invocation.
When OCamlbuild is passed back the command, it uses the tag declarations to determine which, if any, additional flags to insert into the command invocation.
The call <code>tags_of_pathname arg</code> looks up in the <code>_tags</code> file any tags associated with file <code>foo.ml</code>.
To these tags the rule code also adds the two contextual tags <code>ocaml</code> and <code>ocamldep</code> (on which flag declarations may depend).</p>
</div>
<div class="paragraph">
<p>Finally, the command is built:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-nc">Cmd</span><span class="tok-o">(</span><span class="tok-nc">S</span><span class="tok-o">[</span><span class="tok-nc">A</span> <span class="tok-s2">&quot;ocamldep&quot;</span><span class="tok-o">;</span> <span class="tok-nc">T</span> <span class="tok-n">tags</span><span class="tok-o">;</span> <span class="tok-nc">A</span> <span class="tok-s2">&quot;-modules&quot;</span><span class="tok-o">;</span> <span class="tok-nc">P</span> <span class="tok-n">arg</span><span class="tok-o">;</span> <span class="tok-nc">Sh</span> <span class="tok-s2">&quot;&gt;&quot;</span><span class="tok-o">;</span> <span class="tok-nc">Px</span> <span class="tok-n">out</span><span class="tok-o">])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We already mentioned above the constructors <code>S</code>, <code>A</code> and <code>P</code> of the <code>command.spec</code> type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>S</code> just builds a sequence by concatenating sequent fragments;</p>
</li>
<li>
<p><code>A</code> is used for ‘atoms’ (fragments of text to be included as-is, but may be escaped to make them syntactic shell code); and</p>
</li>
<li>
<p><code>P</code> denotes a filesystem path that should be quoted.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The constructor <code>T</code> is used to embed tags within a command.
Mind that passing <code>T</code> twice, one with the tag set <code>ocaml, ocamldep</code> and the other with the tag <code>foo</code>, is not equivalent to passing <code>ocaml, ocamldep, foo</code> together, as the transformation of tags into flags proceeds on each <code>T</code> fragment separately.</p>
</div>
<div class="paragraph">
<p><code>Sh</code> is used for bits of raw shell code that should not be quoted at all, here the output redirection <code>&gt;</code>.
Finally, <code>Px</code> indicates a filesystem path just as <code>P</code>, but it adds the information that this filesystem path is the path of the target produced by this rule.
This information is used by OCamlbuild for logging purposes.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">🛈</div>
</td>
<td class="content">
<div class="title">Tags handling in rules</div>
<div class="paragraph">
<p>It is entirely the rule author&#8217;s responsibility to include tags in the action&#8217;s command.
In particular, it is the code of the rule&#8217;s action that decides which, if any, tags are taken into account and if they come from the rule dependencies, products or both.
(Unfortunately, the built-in rules themselves are sometimes inconsistent on this.)</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_dynamic_dependencies"><a class="anchor" href="#_dynamic_dependencies"></a>Dynamic dependencies</h5>
<div class="paragraph">
<p>In the action <code>ocamldep_ml_command</code> of the previous example, the <code>~build</code> parameter (of type <code>PLUGIN.builder</code>) was ignored, because the rule had no dynamic dependencies.
Therefore there was no need to build extra targets determined during the execution of the rule itself.
The static dependency is built by <code>ocamlbuild</code>'s resolution engine before the action executed.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">target_list</span> <span class="tok-n">env</span> <span class="tok-n">build</span> <span class="tok-o">=</span>
    <span class="tok-k">let</span> <span class="tok-n">itarget</span> <span class="tok-o">=</span> <span class="tok-n">env</span> <span class="tok-s2">&quot;%.itarget&quot;</span> <span class="tok-k">in</span>
    <span class="tok-k">let</span> <span class="tok-n">targets</span> <span class="tok-o">=</span>
      <span class="tok-k">let</span> <span class="tok-n">dir</span> <span class="tok-o">=</span> <span class="tok-nn">Pathname</span><span class="tok-p">.</span><span class="tok-n">dirname</span> <span class="tok-n">itarget</span> <span class="tok-k">in</span>
      <span class="tok-k">let</span> <span class="tok-n">files</span> <span class="tok-o">=</span> <span class="tok-n">string_list_of_file</span> <span class="tok-n">itarget</span> <span class="tok-k">in</span>
      <span class="tok-nn">List</span><span class="tok-p">.</span><span class="tok-n">map</span> <span class="tok-o">(</span><span class="tok-k">fun</span> <span class="tok-n">file</span> <span class="tok-o">-&gt;</span> <span class="tok-o">[</span><span class="tok-nn">Pathname</span><span class="tok-p">.</span><span class="tok-n">concat</span> <span class="tok-n">dir</span> <span class="tok-n">file</span><span class="tok-o">])</span> <span class="tok-n">files</span>
    <span class="tok-k">in</span>
    <span class="tok-k">let</span> <span class="tok-n">results</span> <span class="tok-o">=</span> <span class="tok-nn">List</span><span class="tok-p">.</span><span class="tok-n">map</span> <span class="tok-nn">Outcome</span><span class="tok-p">.</span><span class="tok-n">good</span> <span class="tok-o">(</span><span class="tok-n">build</span> <span class="tok-n">targets</span><span class="tok-o">)</span> <span class="tok-k">in</span>
    <span class="tok-k">let</span> <span class="tok-n">link_command</span> <span class="tok-n">result</span> <span class="tok-o">=</span>
      <span class="tok-nc">Cmd</span> <span class="tok-o">(</span><span class="tok-nc">S</span> <span class="tok-o">[</span><span class="tok-nc">A</span> <span class="tok-s2">&quot;ln&quot;</span><span class="tok-o">;</span> <span class="tok-nc">A</span> <span class="tok-s2">&quot;-sf&quot;</span><span class="tok-o">;</span>
              <span class="tok-nc">P</span> <span class="tok-o">(</span><span class="tok-nn">Pathname</span><span class="tok-p">.</span><span class="tok-n">concat</span> <span class="tok-o">!</span><span class="tok-nn">Options</span><span class="tok-p">.</span><span class="tok-n">build_dir</span> <span class="tok-n">result</span><span class="tok-o">);</span>
              <span class="tok-nc">A</span> <span class="tok-nn">Pathname</span><span class="tok-p">.</span><span class="tok-n">pwd</span><span class="tok-o">])</span>
    <span class="tok-k">in</span>
    <span class="tok-nc">Seq</span> <span class="tok-o">(</span><span class="tok-nn">List</span><span class="tok-p">.</span><span class="tok-n">map</span> <span class="tok-n">link_command</span> <span class="tok-n">results</span><span class="tok-o">)</span>

<span class="tok-n">rule</span> <span class="tok-s2">&quot;target files&quot;</span>
  <span class="tok-o">~</span><span class="tok-n">dep</span><span class="tok-o">:</span><span class="tok-s2">&quot;%.itarget&quot;</span>
  <span class="tok-o">~</span><span class="tok-n">stamp</span><span class="tok-o">:</span><span class="tok-s2">&quot;%.otarget&quot;</span>
  <span class="tok-o">~</span><span class="tok-n">doc</span><span class="tok-o">:</span><span class="tok-s2">&quot;If foo.itarget contains a list of ocamlbuild targets, \</span>
<span class="tok-s2">        asking ocamlbuild to produce foo.otarget will \</span>
<span class="tok-s2">        build each of those targets in turn.&quot;</span>
  <span class="tok-n">target_list</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>string_list_of_file</code> function reads a file and returns the list of its lines.
It is used in the various built-in rules for files containing other file or module paths (e.g., <code>.mllib</code>, <code>.odocl</code> or here <code>.itarget</code>).</p>
</div>
<div class="paragraph">
<p>The function <code>build</code> takes as argument a list of lists, to be understood as a conjunction of disjunctions.
For example, if passed the input <code>[["a/foo.byte"; "b/foo.byte"]; ["a/foo.native"; "b/foo.native"]]</code>, it
tries to build ( (<code>a/foo.byte</code> OR <code>b/foo.byte</code>) AND (<code>a/foo.native</code> OR <code>b/foo.native</code>) ).
The disjunctive structure (this OR that) is useful because we are often not quite sure where a particular target may be (for example the module <code>Foo</code> may be in any of the subdirectories in the include path).
The conjunctive structure (this AND that) is essential to parallelizing the build, since <code>ocamlbuild</code> tries to build all these targets in parallel, whereas sequential invocation of the build function on each of the disjunctions would give sequential builds.</p>
</div>
<div class="paragraph">
<p>The function <code>build</code> returns a list of outcomes (<code>(string, exn) Outcome.t</code>&#8201;&#8212;&#8201;<code>Outcome.t</code> is just a disjoint-sum type),
that is either a <code>string</code> (the possible target that could be built) or an exception.
<code>Outcome.good</code> returns the good result if it exists, or raises the exception.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stamps"><a class="anchor" href="#_stamps"></a>3.2. Stamps</h3>
<div class="paragraph">
<p>In the rule above, the production <code>"%.otarget"</code> is not passed as <code>~prod</code> parameter, but as a <code>~stamp</code>.
Stamps are special files that record the list of digests of the dynamic dependencies of the rule that produced them.</p>
</div>
<div class="paragraph">
<p>This is useful to know whether a target should be re-compiled, or whether it is already up-to-date from a previous build and can be just kept as-is.
Imagine that a rule to produce a file <code>foo.weird</code> depends on the rules listed in the corresponding <code>foo.itarget</code> (and then performs some build action).
When should <code>foo.weird</code> be rebuilt, and when is it up-to-date?
More precisely, after we have built the targets of <code>foo.itarget</code>, how do we know whether we should re-run the build action of <code>foo.weird</code>?
Obviously, just checking if the <code>foo.itarget</code> file changed is not enough (the list of targets could be identical and yet, if one of the target changed, <code>foo.weird</code> must be rebuilt).</p>
</div>
<div class="paragraph">
<p>This is where <code>foo.otarget</code> comes in: because it contains a list of digests of the dependencies of <code>foo.itarget</code>, <code>foo.weird</code> can statically depend on <code>foo.otarget</code>.
<code>foo.weird</code> does not need to depend on <code>foo.itarget</code> directly, and it will transitively depend on it through <code>foo.otarget</code>.
This stamp file will change each time one of the <code>foo.itarget</code> elements changes, and thus <code>foo.weird</code> will be rebuilt exactly as necessary.</p>
</div>
<div class="paragraph">
<p>Such stamps should be used each time a rule has no natural file output to use as output (the case of <code>.itarget</code>), or when this file output does not contain enough information for its digest to correctly require rebuilding.
The latter case occurs in the rule to build <code>ocamldoc</code> documentation <code>%.docdir/index.html</code>: the <code>index.html</code> only lists the documented modules.
It does not contain their documentation&#8201;&#8212;&#8201;that is in other files generated.
The rule thus produces a stamp <code>%.docdir/html.stamp</code>.
You should only depend on that stamp if you want your rule to be executed <em>each time</em> the documentation changes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_pattern_variables"><a class="anchor" href="#_pattern_variables"></a>3.3. Pattern variables</h3>
<div class="paragraph">
<p>Most rules need exactly one pattern variable and use <code>%</code> for this purpose.
You may use any string of the form <code>%(identifier)</code> as pattern variable, or even <code>%(identifier:pattern)</code>, in which case the pattern will be only be matched by a string matching the corresponding <code>pattern</code>.
For example, the rule to produce the dynamic library archive <code>dllfoo.so</code> from the file list <code>libfoo.clib</code> starts as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-n">rule</span> <span class="tok-s2">&quot;ocaml C stubs: clib &amp; (o|obj)* -&gt; (a|lib) &amp; (so|dll)&quot;</span>
    <span class="tok-o">~</span><span class="tok-n">prods</span><span class="tok-o">:([</span><span class="tok-s2">&quot;%(path:&lt;**/&gt;)lib%(libname:&lt;*&gt; and not &lt;*.*&gt;)&quot;</span><span class="tok-o">-.-</span><span class="tok-n">ext_lib</span><span class="tok-o">]</span> <span class="tok-o">@</span>
          <span class="tok-k">if</span> <span class="tok-nn">Ocamlbuild_config</span><span class="tok-p">.</span><span class="tok-n">supports_shared_libraries</span> <span class="tok-k">then</span>
            <span class="tok-o">[</span><span class="tok-s2">&quot;%(path:&lt;**/&gt;)dll%(libname:&lt;*&gt; and not &lt;*.*&gt;)&quot;</span><span class="tok-o">-.-</span><span class="tok-n">ext_dll</span><span class="tok-o">]</span>
          <span class="tok-k">else</span>
            <span class="tok-bp">[]</span><span class="tok-o">)</span>
    <span class="tok-o">~</span><span class="tok-n">dep</span><span class="tok-o">:</span><span class="tok-s2">&quot;%(path)lib%(libname).clib&quot;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_complete_example_menhir_support_in_ocamlbuild"><a class="anchor" href="#_complete_example_menhir_support_in_ocamlbuild"></a>3.3.1. Complete example: Menhir support in OCamlbuild</h4>
<div class="listingblock">
<div class="title">Menhir support in OCamlbuild</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-n">rule</span> <span class="tok-s2">&quot;ocaml: modular menhir (mlypack)&quot;</span>
  <span class="tok-o">~</span><span class="tok-n">prods</span><span class="tok-o">:[</span><span class="tok-s2">&quot;%.mli&quot;</span> <span class="tok-o">;</span> <span class="tok-s2">&quot;%.ml&quot;</span><span class="tok-o">]</span>
  <span class="tok-o">~</span><span class="tok-n">deps</span><span class="tok-o">:[</span><span class="tok-s2">&quot;%.mlypack&quot;</span><span class="tok-o">]</span>
  <span class="tok-o">~</span><span class="tok-n">doc</span><span class="tok-o">:</span><span class="tok-s2">&quot;Menhir supports building a parser by composing several .mly files \</span>
<span class="tok-s2">        together, containing different parts of the grammar description. \</span>
<span class="tok-s2">        To use that feature with ocamlbuild, you should create a .mlypack \</span>
<span class="tok-s2">        file with the same syntax as .mllib or .mlpack files: \</span>
<span class="tok-s2">        a whitespace-separated list of the capitalized module names \</span>
<span class="tok-s2">        of the .mly files you want to combine together.&quot;</span>
  <span class="tok-o">(</span><span class="tok-nn">Ocaml_tools</span><span class="tok-p">.</span><span class="tok-n">menhir_modular</span> <span class="tok-s2">&quot;%&quot;</span> <span class="tok-s2">&quot;%.mlypack&quot;</span> <span class="tok-s2">&quot;%.mlypack.depends&quot;</span><span class="tok-o">);</span>

<span class="tok-n">rule</span> <span class="tok-s2">&quot;ocaml: menhir modular dependencies&quot;</span>
  <span class="tok-o">~</span><span class="tok-n">prod</span><span class="tok-o">:</span><span class="tok-s2">&quot;%.mlypack.depends&quot;</span>
  <span class="tok-o">~</span><span class="tok-n">dep</span><span class="tok-o">:</span><span class="tok-s2">&quot;%.mlypack&quot;</span>
  <span class="tok-o">(</span><span class="tok-nn">Ocaml_tools</span><span class="tok-p">.</span><span class="tok-n">menhir_modular_ocamldep_command</span> <span class="tok-s2">&quot;%.mlypack&quot;</span> <span class="tok-s2">&quot;%.mlypack.depends&quot;</span><span class="tok-o">);</span>

<span class="tok-n">rule</span> <span class="tok-s2">&quot;ocaml: menhir&quot;</span>
  <span class="tok-o">~</span><span class="tok-n">prods</span><span class="tok-o">:[</span><span class="tok-s2">&quot;%.ml&quot;</span><span class="tok-o">;</span> <span class="tok-s2">&quot;%.mli&quot;</span><span class="tok-o">]</span>
  <span class="tok-o">~</span><span class="tok-n">deps</span><span class="tok-o">:[</span><span class="tok-s2">&quot;%.mly&quot;</span><span class="tok-o">;</span> <span class="tok-s2">&quot;%.mly.depends&quot;</span><span class="tok-o">]</span>
  <span class="tok-o">~</span><span class="tok-n">doc</span><span class="tok-o">:</span><span class="tok-s2">&quot;Invokes menhir to build the .ml and .mli files derived from a .mly \</span>
<span class="tok-s2">        grammar. If you want to use ocamlyacc instead, you must disable the \</span>
<span class="tok-s2">        -use-menhir option that was passed to ocamlbuild.&quot;</span>
  <span class="tok-o">(</span><span class="tok-nn">Ocaml_tools</span><span class="tok-p">.</span><span class="tok-n">menhir</span> <span class="tok-s2">&quot;%.mly&quot;</span><span class="tok-o">);</span>

<span class="tok-n">rule</span> <span class="tok-s2">&quot;ocaml: menhir dependencies&quot;</span>
  <span class="tok-o">~</span><span class="tok-n">prod</span><span class="tok-o">:</span><span class="tok-s2">&quot;%.mly.depends&quot;</span>
  <span class="tok-o">~</span><span class="tok-n">dep</span><span class="tok-o">:</span><span class="tok-s2">&quot;%.mly&quot;</span>
  <span class="tok-o">(</span><span class="tok-nn">Ocaml_tools</span><span class="tok-p">.</span><span class="tok-n">menhir_ocamldep_command</span> <span class="tok-s2">&quot;%.mly&quot;</span> <span class="tok-s2">&quot;%.mly.depends&quot;</span><span class="tok-o">);</span>

<span class="tok-n">flag</span> <span class="tok-o">[</span><span class="tok-s2">&quot;ocaml&quot;</span><span class="tok-o">;</span> <span class="tok-s2">&quot;menhir&quot;</span><span class="tok-o">]</span> <span class="tok-o">(</span><span class="tok-n">atomize</span> <span class="tok-o">!</span><span class="tok-nn">Options</span><span class="tok-p">.</span><span class="tok-n">ocaml_yaccflags</span><span class="tok-o">);</span>

<span class="tok-n">flag</span> <span class="tok-o">[</span> <span class="tok-s2">&quot;ocaml&quot;</span> <span class="tok-o">;</span> <span class="tok-s2">&quot;menhir&quot;</span> <span class="tok-o">;</span> <span class="tok-s2">&quot;explain&quot;</span> <span class="tok-o">]</span> <span class="tok-o">(</span><span class="tok-nc">S</span><span class="tok-o">[</span><span class="tok-nc">A</span> <span class="tok-s2">&quot;--explain&quot;</span><span class="tok-o">]);</span>
<span class="tok-n">flag</span> <span class="tok-o">[</span> <span class="tok-s2">&quot;ocaml&quot;</span> <span class="tok-o">;</span> <span class="tok-s2">&quot;menhir&quot;</span> <span class="tok-o">;</span> <span class="tok-s2">&quot;infer&quot;</span> <span class="tok-o">]</span> <span class="tok-o">(</span><span class="tok-nc">S</span><span class="tok-o">[</span><span class="tok-nc">A</span> <span class="tok-s2">&quot;--infer&quot;</span><span class="tok-o">]);</span>

<span class="tok-nn">List</span><span class="tok-p">.</span><span class="tok-n">iter</span> <span class="tok-k">begin</span> <span class="tok-k">fun</span> <span class="tok-n">mode</span> <span class="tok-o">-&gt;</span>
  <span class="tok-n">flag</span> <span class="tok-o">[</span> <span class="tok-n">mode</span><span class="tok-o">;</span> <span class="tok-s2">&quot;only_tokens&quot;</span> <span class="tok-o">]</span> <span class="tok-o">(</span><span class="tok-nc">S</span><span class="tok-o">[</span><span class="tok-nc">A</span> <span class="tok-s2">&quot;--only-tokens&quot;</span><span class="tok-o">]);</span>
  <span class="tok-n">pflag</span> <span class="tok-o">[</span> <span class="tok-n">mode</span> <span class="tok-o">]</span> <span class="tok-s2">&quot;external_tokens&quot;</span> <span class="tok-o">(</span><span class="tok-k">fun</span> <span class="tok-n">name</span> <span class="tok-o">-&gt;</span>
    <span class="tok-nc">S</span><span class="tok-o">[</span><span class="tok-nc">A</span> <span class="tok-s2">&quot;--external-tokens&quot;</span><span class="tok-o">;</span> <span class="tok-nc">A</span> <span class="tok-n">name</span><span class="tok-o">]);</span>
          <span class="tok-k">end</span> <span class="tok-o">[</span> <span class="tok-s2">&quot;menhir&quot;</span><span class="tok-o">;</span> <span class="tok-s2">&quot;menhir_ocamldep&quot;</span> <span class="tok-o">];</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>, where the Menhir-specific actions in <code>Ocaml_tools</code> are defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"><span class="tok-k">let</span> <span class="tok-n">menhir_ocamldep_command&#39;</span> <span class="tok-n">tags</span> <span class="tok-o">~</span><span class="tok-n">menhir_spec</span> <span class="tok-n">out</span> <span class="tok-o">=</span>
  <span class="tok-k">let</span> <span class="tok-n">menhir</span> <span class="tok-o">=</span> <span class="tok-k">if</span> <span class="tok-o">!</span><span class="tok-nn">Options</span><span class="tok-p">.</span><span class="tok-n">ocamlyacc</span> <span class="tok-o">=</span> <span class="tok-nc">N</span> <span class="tok-k">then</span> <span class="tok-nc">V</span><span class="tok-s2">&quot;MENHIR&quot;</span> <span class="tok-k">else</span> <span class="tok-o">!</span><span class="tok-nn">Options</span><span class="tok-p">.</span><span class="tok-n">ocamlyacc</span> <span class="tok-k">in</span>
  <span class="tok-nc">Cmd</span><span class="tok-o">(</span><span class="tok-nc">S</span><span class="tok-o">[</span><span class="tok-n">menhir</span><span class="tok-o">;</span> <span class="tok-nc">T</span> <span class="tok-n">tags</span><span class="tok-o">;</span> <span class="tok-nc">A</span><span class="tok-s2">&quot;--raw-depend&quot;</span><span class="tok-o">;</span>
        <span class="tok-nc">A</span><span class="tok-s2">&quot;--ocamldep&quot;</span><span class="tok-o">;</span> <span class="tok-nc">Quote</span> <span class="tok-o">(</span><span class="tok-n">ocamldep_command&#39;</span> <span class="tok-nn">Tags</span><span class="tok-p">.</span><span class="tok-n">empty</span><span class="tok-o">);</span>
        <span class="tok-n">menhir_spec</span> <span class="tok-o">;</span> <span class="tok-nc">Sh</span> <span class="tok-s2">&quot;&gt;&quot;</span><span class="tok-o">;</span> <span class="tok-nc">Px</span> <span class="tok-n">out</span><span class="tok-o">])</span>

<span class="tok-k">let</span> <span class="tok-n">menhir_ocamldep_command</span> <span class="tok-n">arg</span> <span class="tok-n">out</span> <span class="tok-n">env</span> <span class="tok-o">_</span><span class="tok-n">build</span> <span class="tok-o">=</span>
  <span class="tok-k">let</span> <span class="tok-n">arg</span> <span class="tok-o">=</span> <span class="tok-n">env</span> <span class="tok-n">arg</span> <span class="tok-ow">and</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">env</span> <span class="tok-n">out</span> <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-n">tags</span> <span class="tok-o">=</span> <span class="tok-n">tags_of_pathname</span> <span class="tok-n">arg</span><span class="tok-o">++</span><span class="tok-s2">&quot;ocaml&quot;</span><span class="tok-o">++</span><span class="tok-s2">&quot;menhir_ocamldep&quot;</span> <span class="tok-k">in</span>
  <span class="tok-n">menhir_ocamldep_command&#39;</span> <span class="tok-n">tags</span> <span class="tok-o">~</span><span class="tok-n">menhir_spec</span><span class="tok-o">:(</span><span class="tok-nc">P</span> <span class="tok-n">arg</span><span class="tok-o">)</span> <span class="tok-n">out</span>

<span class="tok-k">let</span> <span class="tok-n">import_mlypack</span> <span class="tok-n">build</span> <span class="tok-n">mlypack</span> <span class="tok-o">=</span>
  <span class="tok-k">let</span> <span class="tok-n">tags1</span> <span class="tok-o">=</span> <span class="tok-n">tags_of_pathname</span> <span class="tok-n">mlypack</span> <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-n">files</span> <span class="tok-o">=</span> <span class="tok-n">string_list_of_file</span> <span class="tok-n">mlypack</span> <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-n">include_dirs</span> <span class="tok-o">=</span> <span class="tok-nn">Pathname</span><span class="tok-p">.</span><span class="tok-n">include_dirs_of</span> <span class="tok-o">(</span><span class="tok-nn">Pathname</span><span class="tok-p">.</span><span class="tok-n">dirname</span> <span class="tok-n">mlypack</span><span class="tok-o">)</span> <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-n">files_alternatives</span> <span class="tok-o">=</span>
    <span class="tok-nn">List</span><span class="tok-p">.</span><span class="tok-n">map</span> <span class="tok-k">begin</span> <span class="tok-k">fun</span> <span class="tok-n">module_name</span> <span class="tok-o">-&gt;</span>
      <span class="tok-n">expand_module</span> <span class="tok-n">include_dirs</span> <span class="tok-n">module_name</span> <span class="tok-o">[</span><span class="tok-s2">&quot;mly&quot;</span><span class="tok-o">]</span>
    <span class="tok-k">end</span> <span class="tok-n">files</span>
  <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-n">files</span> <span class="tok-o">=</span> <span class="tok-nn">List</span><span class="tok-p">.</span><span class="tok-n">map</span> <span class="tok-nn">Outcome</span><span class="tok-p">.</span><span class="tok-n">good</span> <span class="tok-o">(</span><span class="tok-n">build</span> <span class="tok-n">files_alternatives</span><span class="tok-o">)</span> <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-n">tags2</span> <span class="tok-o">=</span>
    <span class="tok-nn">List</span><span class="tok-p">.</span><span class="tok-n">fold_right</span>
      <span class="tok-o">(</span><span class="tok-k">fun</span> <span class="tok-n">file</span> <span class="tok-o">-&gt;</span> <span class="tok-nn">Tags</span><span class="tok-p">.</span><span class="tok-n">union</span> <span class="tok-o">(</span><span class="tok-n">tags_of_pathname</span> <span class="tok-n">file</span><span class="tok-o">))</span>
      <span class="tok-n">files</span> <span class="tok-n">tags1</span>
  <span class="tok-k">in</span>
  <span class="tok-o">(</span><span class="tok-n">tags2</span><span class="tok-o">,</span> <span class="tok-n">files</span><span class="tok-o">)</span>

<span class="tok-k">let</span> <span class="tok-n">menhir_modular_ocamldep_command</span> <span class="tok-n">mlypack</span> <span class="tok-n">out</span> <span class="tok-n">env</span> <span class="tok-n">build</span> <span class="tok-o">=</span>
  <span class="tok-k">let</span> <span class="tok-n">mlypack</span> <span class="tok-o">=</span> <span class="tok-n">env</span> <span class="tok-n">mlypack</span> <span class="tok-ow">and</span> <span class="tok-n">out</span> <span class="tok-o">=</span> <span class="tok-n">env</span> <span class="tok-n">out</span> <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-o">(</span><span class="tok-n">tags</span><span class="tok-o">,</span><span class="tok-n">files</span><span class="tok-o">)</span> <span class="tok-o">=</span> <span class="tok-n">import_mlypack</span> <span class="tok-n">build</span> <span class="tok-n">mlypack</span> <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-n">tags</span> <span class="tok-o">=</span> <span class="tok-n">tags</span><span class="tok-o">++</span><span class="tok-s2">&quot;ocaml&quot;</span><span class="tok-o">++</span><span class="tok-s2">&quot;menhir_ocamldep&quot;</span> <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-n">menhir_base</span> <span class="tok-o">=</span> <span class="tok-nn">Pathname</span><span class="tok-p">.</span><span class="tok-n">remove_extensions</span> <span class="tok-n">mlypack</span> <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-n">menhir_spec</span> <span class="tok-o">=</span> <span class="tok-nc">S</span><span class="tok-o">[</span><span class="tok-nc">A</span> <span class="tok-s2">&quot;--base&quot;</span> <span class="tok-o">;</span> <span class="tok-nc">P</span> <span class="tok-n">menhir_base</span> <span class="tok-o">;</span> <span class="tok-n">atomize_paths</span> <span class="tok-n">files</span><span class="tok-o">]</span> <span class="tok-k">in</span>
  <span class="tok-n">menhir_ocamldep_command&#39;</span> <span class="tok-n">tags</span> <span class="tok-o">~</span><span class="tok-n">menhir_spec</span> <span class="tok-n">out</span>

<span class="tok-k">let</span> <span class="tok-n">menhir_modular</span> <span class="tok-n">menhir_base</span> <span class="tok-n">mlypack</span> <span class="tok-n">mlypack_depends</span> <span class="tok-n">env</span> <span class="tok-n">build</span> <span class="tok-o">=</span>
  <span class="tok-k">let</span> <span class="tok-n">menhir</span> <span class="tok-o">=</span> <span class="tok-k">if</span> <span class="tok-o">!</span><span class="tok-nn">Options</span><span class="tok-p">.</span><span class="tok-n">ocamlyacc</span> <span class="tok-o">=</span> <span class="tok-nc">N</span> <span class="tok-k">then</span> <span class="tok-s2">&quot;menhir&quot;</span> <span class="tok-k">else</span> <span class="tok-o">!</span><span class="tok-nn">Options</span><span class="tok-p">.</span><span class="tok-n">ocamlyacc</span> <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-n">menhir_base</span> <span class="tok-o">=</span> <span class="tok-n">env</span> <span class="tok-n">menhir_base</span> <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-n">mlypack</span> <span class="tok-o">=</span> <span class="tok-n">env</span> <span class="tok-n">mlypack</span> <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-n">mlypack_depends</span> <span class="tok-o">=</span> <span class="tok-n">env</span> <span class="tok-n">mlypack_depends</span> <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-o">(</span><span class="tok-n">tags</span><span class="tok-o">,</span><span class="tok-n">files</span><span class="tok-o">)</span> <span class="tok-o">=</span> <span class="tok-n">import_mlypack</span> <span class="tok-n">build</span> <span class="tok-n">mlypack</span> <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-bp">()</span> <span class="tok-o">=</span> <span class="tok-nn">List</span><span class="tok-p">.</span><span class="tok-n">iter</span> <span class="tok-nn">Outcome</span><span class="tok-p">.</span><span class="tok-n">ignore_good</span> <span class="tok-o">(</span><span class="tok-n">build</span> <span class="tok-o">[[</span><span class="tok-n">mlypack_depends</span><span class="tok-o">]])</span> <span class="tok-k">in</span>
  <span class="tok-nn">Ocaml_compiler</span><span class="tok-p">.</span><span class="tok-n">prepare_compile</span> <span class="tok-n">build</span> <span class="tok-n">mlypack</span><span class="tok-o">;</span>
  <span class="tok-k">let</span> <span class="tok-n">ocamlc_tags</span> <span class="tok-o">=</span> <span class="tok-n">tags</span><span class="tok-o">++</span><span class="tok-s2">&quot;ocaml&quot;</span><span class="tok-o">++</span><span class="tok-s2">&quot;byte&quot;</span><span class="tok-o">++</span><span class="tok-s2">&quot;compile&quot;</span> <span class="tok-k">in</span>
  <span class="tok-k">let</span> <span class="tok-n">tags</span> <span class="tok-o">=</span> <span class="tok-n">tags</span><span class="tok-o">++</span><span class="tok-s2">&quot;ocaml&quot;</span><span class="tok-o">++</span><span class="tok-s2">&quot;parser&quot;</span><span class="tok-o">++</span><span class="tok-s2">&quot;menhir&quot;</span> <span class="tok-k">in</span>
  <span class="tok-nc">Cmd</span><span class="tok-o">(</span><span class="tok-nc">S</span><span class="tok-o">[</span><span class="tok-n">menhir</span> <span class="tok-o">;</span>
        <span class="tok-nc">A</span> <span class="tok-s2">&quot;--ocamlc&quot;</span><span class="tok-o">;</span> <span class="tok-nc">Quote</span><span class="tok-o">(</span><span class="tok-nc">S</span><span class="tok-o">[!</span><span class="tok-nn">Options</span><span class="tok-p">.</span><span class="tok-n">ocamlc</span><span class="tok-o">;</span> <span class="tok-nc">T</span> <span class="tok-n">ocamlc_tags</span><span class="tok-o">;</span> <span class="tok-n">ocaml_include_flags</span> <span class="tok-n">mlypack</span><span class="tok-o">]);</span>
        <span class="tok-nc">T</span> <span class="tok-n">tags</span> <span class="tok-o">;</span> <span class="tok-nc">A</span> <span class="tok-s2">&quot;--base&quot;</span> <span class="tok-o">;</span> <span class="tok-nc">Px</span> <span class="tok-n">menhir_base</span> <span class="tok-o">;</span> <span class="tok-n">atomize_paths</span> <span class="tok-n">files</span><span class="tok-o">])</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-04-18 14:41:33 CEST
</div>
</div>
</body>
</html>